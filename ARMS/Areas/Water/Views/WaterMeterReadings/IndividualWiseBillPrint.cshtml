@*@using CORE_BOL
    @model WaterMeterReadingModel
    @model Byte[]
    @{
        ViewData["Title"] = "IndividualWiseBillPrint";
        Layout = "~/Views/Shared/_Layout.cshtml";
    }*@

@*@model Byte[]
    @addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers*@
@using CORE_BOL
@model WaterMeterReadingModel
@{
    ViewData["Title"] = "IndividualWiseBillPrint";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="content-header">
    <div class="container-fluid">
        <div class="row mb-2">
            <div class="col-sm-6">
                <h1 class="m-0 text-dark"></h1>
            </div>
            <div class="col-sm-6">
                <ol class="breadcrumb float-sm-right">
                    <li class="breadcrumb-item"><a href="IndividualWiseBillPrint">Consumer Wise Bill Print</a></li>
                    <li class="breadcrumb-item active">Water Transaction</li>
                </ol>
            </div>
        </div>
    </div>
</div>




<!--SEARCH-->

<div class="card card-info">
    <div class="card-header">
        <h3 class="card-title">Individual Wise Bill Generation</h3>
    </div>
    <div class="card-body">
        <div class="form-group row ">
            <div class="input-group  col-5">
                <label class="col-sm-4 col-form-label">Consumer No:</label>
                <input type="text" class="form-control col-sm-8" id="IDconsumerno" name="IDconsumerno" />
            </div>
            <div class="input-group  col-5">
                <label class="col-sm-4 col-form-label">Year:</label>
                <select id="IDyear" class="form-control col-sm-6 select2bs4"
                        asp-items="@(new SelectList (@ViewBag.Year,"Value","Text")) " value="0"></select>
            </div>
            <div class="input-group col-2 float-left">
                <input type="button" id="btnSubmit" value="Search" autocomplete="off" class="btn btn-primary col-10 " onclick="return displayBillDetails();" />
                @*<button id="btnSubmit" class="btn btn-primary col-10 " onclick="return displayBillDetails();">Search</button>*@
            </div>
        </div>
        <div class="form-group row ">
            <div class="input-group  col-5">
                <label class="col-sm-4 col-form-label">Month:</label>
                <select id="IDmonth" class="form-control col-sm-6 select2bs4"
                        asp-items="@(new SelectList (@ViewBag.Month,"Value","Text")) " value="0"></select>
            </div>
            <div class="input-group  col-5">
                <label class="col-sm-4 col-form-label">Bill Type:</label>
                <select id="IDBillType" class="form-control col-sm-6 select2bs4" value="0">
                    <option>-- Select One --</option>
                    <option value="1">Current Account Bill</option>
                    <option value="2">Old Account Bill</option>
                </select>
            </div>
            <div class="input-group col-2 float-left">
                <input type="button" value="Print" class="btn btn-primary col-10 " onclick="return PrintBillDetails();" />
            </div>
        </div>
    </div>
</div>

<!--INDIVIDUAL BILL-->
<div class="card card-info" id="idBillInfo" style="display:none;">
    <div class="card-header">
        <div class="card-title">Water & Sewerage Service Charges Bill</div>
    </div>
    <div class="card-body" id="IDBill" style="background-color:whitesmoke">
        <table width="100%" style="border-collapse: collapse; font-size:10px; ">

            <tr><td></td></tr>
            <tr><td colspan="5" style="font-size: 14px;" align="center"><b>(Water & Sewerage Service Charges Bill)</b></td></tr>
            <tr>
                <td colspan="4"><img src="~/dist/img/tt_logo.gif" height="80px" width="80px" /></td>

                <td align="right";><img id="qrDemandNo" height="80px" width="80px" /></td>

                @*<td><img src="../images/thimphuthromde.png" height="50px" width="50px" /></td>*@
            </tr>


            <tr>
                <td style="width:85px; font-size: 10px;" colspan="1">
                    <strong>Bill For :</strong>
                </td>
                <td style="width:85px; font-size: 10px;" align="left">
                    <Label id="lblBillFor"></Label>
                </td>
                <td style="width:85px; font-size: 10px;" align="left">
                    <Label id="lblZonename"></Label>
                </td>
                <td align="left">

                    <strong>  Meter Status:</strong>
                </td>
                <td>
                    <Label id="lblmeterstatus"></Label>
                </td>
            </tr>
            <tr>
                <td style="width:85px; font-size: 10px;">
                    <strong>  Bill No:</strong>&nbsp;&nbsp;&nbsp;
                </td>
                <td style="width:85px; font-size: 10px;">
                    <Label id="lblbillno"></Label>
                </td>
                <td style="width:85px; font-size: 10px;">
                </td>
                <td style="width:85px; font-size: 10px;">
                    <strong>  Payment Status:</strong>&nbsp;
                </td>
                <td>

                    <Label id="lblpaymentstatus"></Label>
                </td>
            </tr>
            <tr>
                <td>
                    <strong>   Bill Date:</strong>&nbsp;

                </td>
                <td>
                    <Label id="lblbilldate"></Label>
                    &nbsp;
                </td>
                <td></td>
                <td>  <strong>  Due Date:</strong></td>
                <td>

                    <Label id="lblduedate"></Label>

                </td>
            </tr>
            @*<%--
                <tr><td colspan="5"><hr /></td></tr>--%>
                <%--
                <tr>
                    <td>Name:</td>
                    <td><Label id="lblname" ></Label> </td>
                    <td></td>
                    <td>Consumer No.:</td>
                    <td><Label id="lblconsumerno" ></Label> </td>
                </tr>--%>*@
            <tr>
                <td style="width:75px;"><strong> Billing Address:</strong></td>
                <td colspan="2"><Label id="lblbillingaddress"></Label> </td>

                <td><strong> Meter No:</strong></td>
                <td><Label id="lblmeterno"></Label> </td>
            </tr>
            <tr>
                <td style="width:75px;"><strong> Consumer No:</strong></td>
                <td><Label id="lblconsumerno"></Label></td>

                <td>
                    <strong>Standard Consumption:</strong> <Label id="lblStandardConsumption"></Label>
</td>

                <td><strong> Category:</strong></td>
                <td><Label id="lblcategory"></Label>[<Label id="lblNoOfUnits"></Label>  Unit(s)]</td>
            </tr>
            @*<%--
                <tr>
                    <td></td>
                    <td></td>
                    <td>No. of Units:</td>
                    <td><Label id="lblnoofunits" ></Label> </td>
                </tr>
                <tr>
                    <td></td>
                    <td></td>
                    <td>House:</td>
                    <td><Label id="Label8" ></Label> </td>
                </tr>--%>*@

            <!--TABLE 1-->
            <tr>
                <td colspan="2" width="40%" style="border:1px solid #000000; width:40%;"><b>Previous Meter Reading</b></td>
                <td colspan="2" width="40%" style="border:1px solid #000000; width:40%;"><b>Current Meter Reading</b></td>
                <td width="20%" style="border:1px solid #000000; width:20%;"><b>Consumption for the month (CUM)</b></td>

            </tr>

            <tr>
                <td style="border:1px solid #000000; width:15%;">Reading</td>
                <td style="border:1px solid #000000; width:15%;">Date</td>
                <td style="border:1px solid #000000; width:15%;">Reading</td>
                <td style="border:1px solid #000000; width:15%;">Date</td>
                <td style="border:1px solid #000000; width:40%;"></td>

            </tr>
            <tr>
                <td style="border:1px solid #000000; width:20%;"><Label id="lblprevreading"></Label> </td>
                <td style="border:1px solid #000000; width:20%;"><Label id="lblprevdate"></Label></td>
                <td style="border:1px solid #000000; width:20%;"><Label id="lblcurreading"></Label></td>
                <td style="border:1px solid #000000; width:20%;"><Label id="lblcurdate"></Label></td>
                <td style="border:1px solid #000000; width:20%;"><Label id="lblconsumption"></Label></td>

            </tr>
            
            <tr>
                <td colspan="5" align="left">
                    <table width="60%" style="border-collapse: collapse; font-size:9px;">
                        <tr>
                            <td colspan="2"><strong>Utility Charges</strong></td>

                        </tr>
                        @*<tr style="border:1px solid #000000;">
                                <td align="right" style="display:none;"><Label id="lbltransactionid"></Label> </td>
                                <td style="border:1px solid #000000;" width="15%"><strong>Water Bill for the month</strong></td>
                                <td style="border:1px solid #000000;" width="15%"><strong>Service Charges</strong></td>
                                <td style="border:1px solid #000000;" width="15%"><strong>Sewerage Charges</strong></td>
                            </tr>
                            <tbody id="mybody">
                            </tbody>*@

                        <tr style="border:1px solid #000000;">
                            <td>1. Water Bill for the month</td>
                            <td align="right"><Label id="lblwaterbill"></Label> </td>
                        </tr>
                        <tr style="border:1px solid #000000;">
                            <td>2. Meter Rent</td>
                            <td align="right"><Label id="lblservicecharges">0.00</Label> </td>
                        </tr>
                        <tr style="border:1px solid #000000;">
                            <td>3. Sewerage Charges</td>
                            <td align="right"><Label id="lblseweragecharge"></Label> </td>
                        </tr>

                        <tr>
                            <td><b>Total Bill for the month:</b></td>
                            <td align="right"><b><Label id="lbltotalbill"></Label> </b></td>
                        </tr>
                        <tr>
                            <td><b>Outstanding:</b></td>
                            <td align="right"><Label id="lbloutstanding"></Label> </td>
                        </tr>
                        <tr>
                            <td><b>Penalty:</b></td>
                            <td align="right"><Label id="lblpenalty"></Label> </td>
                        </tr>
                        <tr><td></td></tr>

                        <tr style="border:1px solid #000000;">
                            <td><b>Net Amount Payable (Nu):</b></td>
                            <td align="right"><b><Label class="mt-1" id="lblnetamount"></Label></b> </td>
                        </tr>
                    </table>
                </td>
            </tr>

            <tr><td colspan="5" align="right"><b>Billing Incharge</b></td></tr>
            <tr><td colspan="5" align="right"><b>Thimphu Thromde</b></td></tr>



            <tr>
                <td colspan="5">
                    <p style="text-align:justify;">
                        Please pay your bill before due date to avoid 2% penalty. Any decrepency in the bill amount, please contact Billing Cell at 334423.<br>Note:We have upgraded our water billing system to a new system where informations like owner's informations are missing. So<br>
                        individuals are requested to update the correct information at the time of bill
                        payment to avoid any future complication.
                    </p>
                </td>
            </tr>


            <tr>
                <td colspan="3" align="left" style="width:49%;">
                    <table width="50%" style="border-collapse: collapse; font-size:9px;">
                        <tr style="border:1px solid #000000;">
                            <td style="border:1px solid #000000;" width="35%"><strong>Charges Name</strong></td>
                            <td style="border:1px solid #000000;" width="35%" align="right"><strong>Fixed Amount</strong></td>
                            <td style="border:1px solid #000000;" width="35%" align="right"><strong>Percentage</strong></td>
                        </tr>

                        <tr style="border:1px solid #000000;">
                            <td style="border:1px solid #000000;" width="35%" class="style1">Sewerage Charges</td>
                            <td style="border:1px solid #000000;" width="35%" class="style1"></td>
                            <td style="border:1px solid #000000;" width="35%" align="right" class="style1">50</td>
                        </tr>
                        <tr style="border:1px solid #000000; display: none;">
                            <td style="border:1px solid #000000;" width="35%">Service Charges</td>

                            <td style="border:1px solid #000000;" width="35%" align="right" id="idServiceCharges"></td>
                            <td style="border:1px solid #000000;" width="35%" align="right">&nbsp;</td>
                        </tr>

                        <tr><td>&nbsp;</td></tr>
                        <tr><td>&nbsp;</td></tr>
                        <tr><td>&nbsp;</td></tr>
                        <tr><td>&nbsp;</td></tr>
                        <tr><td>&nbsp;</td></tr>
                        <tr><td>&nbsp;</td></tr>
                        <tr><td>&nbsp;</td></tr>
                        <tr><td>&nbsp;</td></tr>
                        <tr><td>&nbsp;</td></tr>
                        <tr><td colspan="3"><b>Payment Status: P--Paid, N--Not Paid</b></td></tr>

                    </table>
                </td>

                <td colspan="2" align="center" style="width:49%;">
                    <table align="right" width="150%" style="border-collapse: collapse; font-size: 9px;">

                        <!--Table Head-->
                        <tr style="border:1px solid #000000;">
                            <td style="border:1px solid #000000;" width="15%"><strong>Category</strong></td>
                            <td style="border:1px solid #000000;" width="15%"><strong>Minimum</strong></td>
                            <td style="border:1px solid #000000;" width="15%"><strong>Maximum</strong></td>
                            <td style="border:1px solid #000000;" width="15%"><strong>Rate</strong></td>
                        </tr>
                        <tbody id="tblbody">
                        </tbody>
                    </table>
                </td>
            </tr>
        </table>
    </div>
</div>
<input hidden id="TransactionId"/>
<script>
        function displayBillDetails() {
            if ($('#IDconsumerno').val() == "") {
                swal("Please fill all the fields!", "", "error");
                $('#IDconsumerno').focus();
                return false;
            }

            var ConsumerNo = $('#IDconsumerno').val();
            var Year = $('#IDyear').val();
            var Month = $('#IDmonth').val();
        //OVERALL INFORMATION
        $.ajax({
            type: "GET",
            url: '@Url.Action("GetBillingInfo", "WaterMeterReadings")',
            data: {
                consumerno: ConsumerNo,
                year: Year,
                month: Month
            },
            dataType: 'JSON',
            contentType: 'application/json, charset=utf-8',

            success: function (data) {

                if (data.length > 0) {

                    var BillingAddress = data[0].billingAddress;
                    var ZoneName = data[0].zoneName;
                    var WaterConnectionStatusName = data[0].waterConnectionStatusName;
                    var ConsumerNo = data[0].consumerNo;
                    var WaterConnectionName = data[0].waterConnectionName;
                    var WaterMeterNo = data[0].waterMeterNo;
                    var Reading = data[0].reading;
                    var ReadingDate = data[0].readingDate;
                    var PreviousReading = data[0].previousReading;
                    var PreviousReadingDate = data[0].previousReadingDate;
                    var NoOfUnit = data[0].noOfUnit;
                    var Consumption = data[0].consumption;
                    var BillDate = data[0].billDate;
                    var DueDate = data[0].duedate;
                    var PaymentStatus = data[0].paymentStatus;
                    var BillFor = data[0].billFor;
                    var DemandNo = data[0].demandNo;
                    var TransactionId = data[0].transactionId;


                    //Displaying Date
                    const d = new Date(ReadingDate);
                    const RDate = d.getFullYear() + '/' + ("0" + (d.getMonth() + 1)).slice(-2) + '/' + ("0" + d.getDate()).slice(-2)

                    const e = new Date(PreviousReadingDate);
                    const PRDate = e.getFullYear() + '/' + ("0" + (e.getMonth() + 1)).slice(-2) + '/' + ("0" + e.getDate()).slice(-2)

                    const f = new Date(BillDate);
                    const BDate = f.getFullYear() + '/' + ("0" + (f.getMonth() + 1)).slice(-2) + '/' + ("0" + f.getDate()).slice(-2)

                    const h = new Date(DueDate);
                    const DDate = h.getFullYear() + '/' + ("0" + (h.getMonth() + 1)).slice(-2) + '/' + ("0" + h.getDate()).slice(-2)

                    //Bill For
                    const g = new Date(BillFor);
                    const Bfor = g.toLocaleString('default', { month: 'long' }) + ',' + g.getFullYear()

                    ////Due Date
                    //const h = new Date(BillDate);
                    //h.setDate(h.getMonth() + 1);
                    //const DueDate = h.getFullYear() + '/' + ("0" + (h.getMonth() + 1)).slice(-2) + '/' + ("0" + h.getDate()).slice(-2)

                    //const DueDate = h.setMonth(h.getMonth() + 1);

                    $('#lblZonename').text(ZoneName);
                    $('#lblmeterstatus').text(WaterConnectionStatusName);
                    $('#lblbillingaddress').text(BillingAddress);
                    $('#lblmeterno').text(WaterMeterNo);
                    $('#lblconsumerno').text(ConsumerNo);
                    $('#lblStandardConsumption').text(data[0].standardConsumption);
                    
                    $('#lblcategory').text(WaterConnectionName);
                    $('#lblNoOfUnits').text(NoOfUnit);
                    $('#lblprevreading').text(PreviousReading);
                    $('#lblprevdate').text(PRDate);
                    $('#lblcurreading').text(Reading);
                    $('#lblcurdate').text(RDate);
                    $('#lblconsumption').text(Consumption);
                    $('#lblbilldate').text(BDate);
                    $('#lblpaymentstatus').text(PaymentStatus);
                    $('#lblBillFor').text(Bfor);
                    $('#lblbillno').text(DemandNo);
                    $('#lblduedate').text(DDate);
                    $('#TransactionId').val(TransactionId);

                    $('#idBillInfo').show(1000);
                    $('#qrDemandNo').attr('src', `data:image/png;base64,${data[0].qrImage}`);
                    //UTILITY CHARGES INFO
            var transactionId = $('#TransactionId').val();
        $.ajax({
            type: "GET",
            url: '@Url.Action("GetUtilityChargesInfo", "WaterMeterReadings")',
            data: {
                consumerno: ConsumerNo,
                id: transactionId,
                CalendarYear: Year
            },
            dataType: 'JSON',
            contentType: 'application/json, charset=utf-8',

            success: function (data) {

                $('#mybody').empty();
                if (data.length > 0) {
                    $.each(data, function (key, value) {
                        //$('#mybody').append(
                            //'<tr style="border:1px solid #000000;">'
                            //+ '<td style="border:1px solid #000000;" width="35%" class="style1">'+ value.waterBillForTheMonth + '</td>'
                            ////+ '<td style="border:1px solid #000000;" width="15%" class="style1">' + 0.0 + '</td>'
                            ////+ '<td style="border:1px solid #000000;" width="15%" class="style1">' + value.sewerageAmount + '</td>'
                            //+ '</tr>'
                        //);

                        var WaterBillForTheMonth = data[0].waterBillForTheMonth;
                        var SewerageAmount = value.sewerageAmount;
                        var TotalBillForTheMonth = value.totalBillForTheMonth;
                        var OutStandingAmount = value.outStandingAmount;
                        var PenaltyAmount = value.penaltyAmount;
                        var NetPayableAmount = value.netPayableAmount;

                        var NPA = 0;
                        var NPA = TotalBillForTheMonth + OutStandingAmount + PenaltyAmount;
                        $('#lblwaterbill').text(WaterBillForTheMonth);
                        $('#lblseweragecharge').text(SewerageAmount);
                        $('#lbltotalbill').text(TotalBillForTheMonth);
                        $('#lbloutstanding').text(OutStandingAmount);
                        $('#lblpenalty').text(PenaltyAmount);
                        $('#lblnetamount').text(NPA.toFixed(2));
                    });
                } else {
                    swal("No Record Found!", "", "warning");
                }
            },
            error: function () {
                $('#img').hide();
                alert('Error occured');
            }
        });
                } else {
                    swal("No Record Found!", "", "warning");
                    $('#idBillInfo').hide(1000);

                }
            },
            error: function () {
                $('#img').hide();
                alert('Error occured');
            }
        });

         //SLAB AND RATE INFORMATION
        $.ajax({
            type: "GET",
            url: '@Url.Action("GetSlabInfo", "WaterMeterReadings")',
            data: {

            },
            dataType: 'JSON',
            contentType: 'application/json, charset=utf-8',

            success: function (data) {
                $('#tblbody').empty();
                if (data.length > 0) {
                    $.each(data, function (key, value) {

                        $('#tblbody').append(
                            '<tr style="border:1px solid #000000;">'
                            + '<td style="border:1px solid #000000;" width="35%" class="style1">' + value.slabName + '</td>'
                            + '<td style="border:1px solid #000000;" width="15%" class="style1">' + value.slabStart + '</td>'
                            + '<td style="border:1px solid #000000;" width="15%" class="style1">' + value.slabEnd + '</td>'
                            + '<td style="border:1px solid #000000;" width="15%" class="style1">' + value.rate + '</td>'
                            + '</tr>'
                        );
                    });

                } else {
                    swal("No Record Found!", "", "warning");
                }
            },
            error: function () {
                $('#img').hide();
                alert('Error occured');
            }
        });


        //WATER SERVICE CHARGES INFO
        $.ajax({
            type: "GET",
            url: '@Url.Action("GetServiceChargesInfo", "WaterMeterReadings")',
            data: {

            },
            dataType: 'JSON',
            contentType: 'application/json, charset=utf-8',

            success: function (data) {

                if (data.length > 0) {
                    var ServiceCharges = data[0].serviceChargeAmount;
                    $('#idServiceCharges').text(ServiceCharges);
                } else {
                    swal("No Record Found!", "", "warning");
                }
            },
            error: function () {
                $('#img').hide();
                alert('Error occured');
            }
        });


    }

    function PrintBillDetails() {
        var today = new Date();
        var date = ("0" + today.getDate()).slice(-2) + '/' + ("0" + (today.getMonth() + 1)).slice(-2) + '/' + today.getFullYear()


        var tableToPrint = document.getElementById("IDBill");
        newWin = window.open("");
        newWin.document.write(tableToPrint.outerHTML);
        newWin.print();
        newWin.close();
    }
</script>

