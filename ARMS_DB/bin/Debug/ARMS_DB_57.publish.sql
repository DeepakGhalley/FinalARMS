/*
Deployment script for tt_db

This code was generated by a tool.
Changes to this file may cause incorrect behavior and will be lost if
the code is regenerated.
*/

GO
SET ANSI_NULLS, ANSI_PADDING, ANSI_WARNINGS, ARITHABORT, CONCAT_NULL_YIELDS_NULL, QUOTED_IDENTIFIER ON;

SET NUMERIC_ROUNDABORT OFF;


GO
:setvar DatabaseName "tt_db"
:setvar DefaultFilePrefix "tt_db"
:setvar DefaultDataPath "C:\Program Files\Microsoft SQL Server\MSSQL14.MSSQLSERVER\MSSQL\DATA\"
:setvar DefaultLogPath "C:\Program Files\Microsoft SQL Server\MSSQL14.MSSQLSERVER\MSSQL\DATA\"

GO
:on error exit
GO
/*
Detect SQLCMD mode and disable script execution if SQLCMD mode is not supported.
To re-enable the script after enabling SQLCMD mode, execute the following:
SET NOEXEC OFF; 
*/
:setvar __IsSqlCmdEnabled "True"
GO
IF N'$(__IsSqlCmdEnabled)' NOT LIKE N'True'
    BEGIN
        PRINT N'SQLCMD mode must be enabled to successfully execute this script.';
        SET NOEXEC ON;
    END


GO
USE [$(DatabaseName)];


GO
PRINT N'Dropping [dbo].[FK_mstSlab_ToTable_1]...';


GO
ALTER TABLE [dbo].[mstSlab] DROP CONSTRAINT [FK_mstSlab_ToTable_1];


GO
PRINT N'Dropping [dbo].[FK_mstSlab_ToTable_2]...';


GO
ALTER TABLE [dbo].[mstSlab] DROP CONSTRAINT [FK_mstSlab_ToTable_2];


GO
PRINT N'Dropping [dbo].[FK_mstSlab_ToTable_3]...';


GO
ALTER TABLE [dbo].[mstSlab] DROP CONSTRAINT [FK_mstSlab_ToTable_3];


GO
PRINT N'Dropping [dbo].[FK_mstSlab_ToTable_4]...';


GO
ALTER TABLE [dbo].[mstSlab] DROP CONSTRAINT [FK_mstSlab_ToTable_4];


GO
PRINT N'Dropping [dbo].[FK_mstSlab_ToTable]...';


GO
ALTER TABLE [dbo].[mstSlab] DROP CONSTRAINT [FK_mstSlab_ToTable];


GO
PRINT N'Dropping [dbo].[FK_mstRate_ToTable_1]...';


GO
ALTER TABLE [dbo].[mstRate] DROP CONSTRAINT [FK_mstRate_ToTable_1];


GO
PRINT N'Dropping [dbo].[FK_tblMiscellaneousRecord_ToTable_2]...';


GO
ALTER TABLE [dbo].[tblMiscellaneousRecord] DROP CONSTRAINT [FK_tblMiscellaneousRecord_ToTable_2];


GO
PRINT N'Dropping [dbo].[FK_trnTaxDetail_ToTable]...';


GO
ALTER TABLE [dbo].[trnTaxDetail] DROP CONSTRAINT [FK_trnTaxDetail_ToTable];


GO
PRINT N'Dropping [dbo].[FK_mstTransactionTypeTaxMap_ToTable_1]...';


GO
ALTER TABLE [dbo].[mstTransactionTypeTaxMap] DROP CONSTRAINT [FK_mstTransactionTypeTaxMap_ToTable_1];


GO
PRINT N'Dropping [dbo].[FK_tblLedger_ToTable_0]...';


GO
ALTER TABLE [dbo].[tblLedger] DROP CONSTRAINT [FK_tblLedger_ToTable_0];


GO
PRINT N'Dropping [dbo].[FK_tblDemand_ToTable_3]...';


GO
ALTER TABLE [dbo].[tblDemand] DROP CONSTRAINT [FK_tblDemand_ToTable_3];


GO
PRINT N'Dropping [dbo].[FK_mstRate_ToTable]...';


GO
ALTER TABLE [dbo].[mstRate] DROP CONSTRAINT [FK_mstRate_ToTable];


GO
PRINT N'Dropping [dbo].[FK_tblMiscellaneousRecord_ToTable_1]...';


GO
ALTER TABLE [dbo].[tblMiscellaneousRecord] DROP CONSTRAINT [FK_tblMiscellaneousRecord_ToTable_1];


GO
PRINT N'Dropping [dbo].[FK_mstTaxMaster_ToTable]...';


GO
ALTER TABLE [dbo].[mstTaxMaster] DROP CONSTRAINT [FK_mstTaxMaster_ToTable];


GO
PRINT N'Starting rebuilding table [dbo].[mstSlab]...';


GO
BEGIN TRANSACTION;

SET TRANSACTION ISOLATION LEVEL SERIALIZABLE;

SET XACT_ABORT ON;

CREATE TABLE [dbo].[tmp_ms_xx_mstSlab] (
    [slabId]                INT             IDENTITY (1, 1) NOT NULL,
    [taxId]                 INT             NOT NULL,
    [slabName]              VARCHAR (250)   NOT NULL,
    [landUseSubCategoryId]  INT             NULL,
    [define1]               INT             NULL,
    [define2]               INT             NULL,
    [slabStart]             DECIMAL (18, 2) NULL,
    [slabEnd]               DECIMAL (18, 2) NULL,
    [constructionTypeId]    INT             NULL,
    [buildingUnitUseTypeId] INT             NULL,
    [buildingUnitClassId]   INT             NULL,
    [effectiveDate]         DATE            NULL,
    [isActive]              BIT             NOT NULL,
    [createdOn]             DATETIME        NOT NULL,
    [createdBy]             INT             NOT NULL,
    [modifiedOn]            DATETIME        NULL,
    [modifiedBy]            INT             NULL,
    PRIMARY KEY CLUSTERED ([slabId] ASC)
);

IF EXISTS (SELECT TOP 1 1 
           FROM   [dbo].[mstSlab])
    BEGIN
        SET IDENTITY_INSERT [dbo].[tmp_ms_xx_mstSlab] ON;
        INSERT INTO [dbo].[tmp_ms_xx_mstSlab] ([slabId], [taxId], [slabName], [landUseSubCategoryId], [define1], [define2], [slabStart], [slabEnd], [constructionTypeId], [buildingUnitUseTypeId], [buildingUnitClassId], [isActive], [createdOn], [createdBy], [modifiedOn], [modifiedBy])
        SELECT   [slabId],
                 [taxId],
                 [slabName],
                 [landUseSubCategoryId],
                 [define1],
                 [define2],
                 [slabStart],
                 [slabEnd],
                 [constructionTypeId],
                 [buildingUnitUseTypeId],
                 [buildingUnitClassId],
                 [isActive],
                 [createdOn],
                 [createdBy],
                 [modifiedOn],
                 [modifiedBy]
        FROM     [dbo].[mstSlab]
        ORDER BY [slabId] ASC;
        SET IDENTITY_INSERT [dbo].[tmp_ms_xx_mstSlab] OFF;
    END

DROP TABLE [dbo].[mstSlab];

EXECUTE sp_rename N'[dbo].[tmp_ms_xx_mstSlab]', N'mstSlab';

COMMIT TRANSACTION;

SET TRANSACTION ISOLATION LEVEL READ COMMITTED;


GO
PRINT N'Starting rebuilding table [dbo].[mstTaxMaster]...';


GO
BEGIN TRANSACTION;

SET TRANSACTION ISOLATION LEVEL SERIALIZABLE;

SET XACT_ABORT ON;

CREATE TABLE [dbo].[tmp_ms_xx_mstTaxMaster] (
    [taxId]        INT           IDENTITY (1, 1) NOT NULL,
    [detailHeadId] INT           NOT NULL,
    [taxName]      VARCHAR (350) NOT NULL,
    [isActive]     BIT           NOT NULL,
    [createdBy]    INT           NOT NULL,
    [createdOn]    DATETIME      NOT NULL,
    [modifiedBy]   INT           NULL,
    [modifiedOn]   DATETIME      NULL,
    PRIMARY KEY CLUSTERED ([taxId] ASC)
);

IF EXISTS (SELECT TOP 1 1 
           FROM   [dbo].[mstTaxMaster])
    BEGIN
        SET IDENTITY_INSERT [dbo].[tmp_ms_xx_mstTaxMaster] ON;
        INSERT INTO [dbo].[tmp_ms_xx_mstTaxMaster] ([taxId], [detailHeadId], [taxName], [isActive], [createdBy], [createdOn], [modifiedBy], [modifiedOn])
        SELECT   [taxId],
                 [detailHeadId],
                 [taxName],
                 [isActive],
                 [createdBy],
                 [createdOn],
                 [modifiedBy],
                 [modifiedOn]
        FROM     [dbo].[mstTaxMaster]
        ORDER BY [taxId] ASC;
        SET IDENTITY_INSERT [dbo].[tmp_ms_xx_mstTaxMaster] OFF;
    END

DROP TABLE [dbo].[mstTaxMaster];

EXECUTE sp_rename N'[dbo].[tmp_ms_xx_mstTaxMaster]', N'mstTaxMaster';

COMMIT TRANSACTION;

SET TRANSACTION ISOLATION LEVEL READ COMMITTED;


GO
PRINT N'Creating [dbo].[FK_mstSlab_ToTable_1]...';


GO
ALTER TABLE [dbo].[mstSlab] WITH NOCHECK
    ADD CONSTRAINT [FK_mstSlab_ToTable_1] FOREIGN KEY ([buildingUnitUseTypeId]) REFERENCES [dbo].[mstBuildingUnitUseType] ([buildingUnitUseTypeId]);


GO
PRINT N'Creating [dbo].[FK_mstSlab_ToTable_2]...';


GO
ALTER TABLE [dbo].[mstSlab] WITH NOCHECK
    ADD CONSTRAINT [FK_mstSlab_ToTable_2] FOREIGN KEY ([buildingUnitClassId]) REFERENCES [dbo].[mstBuildingUnitClass] ([buildingUnitClassId]);


GO
PRINT N'Creating [dbo].[FK_mstSlab_ToTable_3]...';


GO
ALTER TABLE [dbo].[mstSlab] WITH NOCHECK
    ADD CONSTRAINT [FK_mstSlab_ToTable_3] FOREIGN KEY ([landUseSubCategoryId]) REFERENCES [dbo].[mstLandUseSubCategory] ([landUseSubCategoryId]);


GO
PRINT N'Creating [dbo].[FK_mstSlab_ToTable_4]...';


GO
ALTER TABLE [dbo].[mstSlab] WITH NOCHECK
    ADD CONSTRAINT [FK_mstSlab_ToTable_4] FOREIGN KEY ([constructionTypeId]) REFERENCES [dbo].[mstConstructionType] ([constructionTypeId]);


GO
PRINT N'Creating [dbo].[FK_mstSlab_ToTable]...';


GO
ALTER TABLE [dbo].[mstSlab] WITH NOCHECK
    ADD CONSTRAINT [FK_mstSlab_ToTable] FOREIGN KEY ([taxId]) REFERENCES [dbo].[mstTaxMaster] ([taxId]);


GO
PRINT N'Creating [dbo].[FK_mstRate_ToTable_1]...';


GO
ALTER TABLE [dbo].[mstRate] WITH NOCHECK
    ADD CONSTRAINT [FK_mstRate_ToTable_1] FOREIGN KEY ([slabId]) REFERENCES [dbo].[mstSlab] ([slabId]);


GO
PRINT N'Creating [dbo].[FK_tblMiscellaneousRecord_ToTable_2]...';


GO
ALTER TABLE [dbo].[tblMiscellaneousRecord] WITH NOCHECK
    ADD CONSTRAINT [FK_tblMiscellaneousRecord_ToTable_2] FOREIGN KEY ([slabId]) REFERENCES [dbo].[mstSlab] ([slabId]);


GO
PRINT N'Creating [dbo].[FK_trnTaxDetail_ToTable]...';


GO
ALTER TABLE [dbo].[trnTaxDetail] WITH NOCHECK
    ADD CONSTRAINT [FK_trnTaxDetail_ToTable] FOREIGN KEY ([taxId]) REFERENCES [dbo].[mstTaxMaster] ([taxId]);


GO
PRINT N'Creating [dbo].[FK_mstTransactionTypeTaxMap_ToTable_1]...';


GO
ALTER TABLE [dbo].[mstTransactionTypeTaxMap] WITH NOCHECK
    ADD CONSTRAINT [FK_mstTransactionTypeTaxMap_ToTable_1] FOREIGN KEY ([taxId]) REFERENCES [dbo].[mstTaxMaster] ([taxId]);


GO
PRINT N'Creating [dbo].[FK_tblDemand_ToTable_3]...';


GO
ALTER TABLE [dbo].[tblDemand] WITH NOCHECK
    ADD CONSTRAINT [FK_tblDemand_ToTable_3] FOREIGN KEY ([taxId]) REFERENCES [dbo].[mstTaxMaster] ([taxId]);


GO
PRINT N'Creating [dbo].[FK_mstRate_ToTable]...';


GO
ALTER TABLE [dbo].[mstRate] WITH NOCHECK
    ADD CONSTRAINT [FK_mstRate_ToTable] FOREIGN KEY ([taxId]) REFERENCES [dbo].[mstTaxMaster] ([taxId]);


GO
PRINT N'Creating [dbo].[FK_tblMiscellaneousRecord_ToTable_1]...';


GO
ALTER TABLE [dbo].[tblMiscellaneousRecord] WITH NOCHECK
    ADD CONSTRAINT [FK_tblMiscellaneousRecord_ToTable_1] FOREIGN KEY ([taxId]) REFERENCES [dbo].[mstTaxMaster] ([taxId]);


GO
PRINT N'Creating [dbo].[FK_mstTaxMaster_ToTable]...';


GO
ALTER TABLE [dbo].[mstTaxMaster] WITH NOCHECK
    ADD CONSTRAINT [FK_mstTaxMaster_ToTable] FOREIGN KEY ([detailHeadId]) REFERENCES [dbo].[mstDetailHead] ([detailHeadId]);


GO
PRINT N'Checking existing data against newly created constraints';


GO
USE [$(DatabaseName)];


GO
ALTER TABLE [dbo].[mstSlab] WITH CHECK CHECK CONSTRAINT [FK_mstSlab_ToTable_1];

ALTER TABLE [dbo].[mstSlab] WITH CHECK CHECK CONSTRAINT [FK_mstSlab_ToTable_2];

ALTER TABLE [dbo].[mstSlab] WITH CHECK CHECK CONSTRAINT [FK_mstSlab_ToTable_3];

ALTER TABLE [dbo].[mstSlab] WITH CHECK CHECK CONSTRAINT [FK_mstSlab_ToTable_4];

ALTER TABLE [dbo].[mstSlab] WITH CHECK CHECK CONSTRAINT [FK_mstSlab_ToTable];

ALTER TABLE [dbo].[mstRate] WITH CHECK CHECK CONSTRAINT [FK_mstRate_ToTable_1];

ALTER TABLE [dbo].[tblMiscellaneousRecord] WITH CHECK CHECK CONSTRAINT [FK_tblMiscellaneousRecord_ToTable_2];

ALTER TABLE [dbo].[trnTaxDetail] WITH CHECK CHECK CONSTRAINT [FK_trnTaxDetail_ToTable];

ALTER TABLE [dbo].[mstTransactionTypeTaxMap] WITH CHECK CHECK CONSTRAINT [FK_mstTransactionTypeTaxMap_ToTable_1];

ALTER TABLE [dbo].[tblDemand] WITH CHECK CHECK CONSTRAINT [FK_tblDemand_ToTable_3];

ALTER TABLE [dbo].[mstRate] WITH CHECK CHECK CONSTRAINT [FK_mstRate_ToTable];

ALTER TABLE [dbo].[tblMiscellaneousRecord] WITH CHECK CHECK CONSTRAINT [FK_tblMiscellaneousRecord_ToTable_1];

ALTER TABLE [dbo].[mstTaxMaster] WITH CHECK CHECK CONSTRAINT [FK_mstTaxMaster_ToTable];


GO
PRINT N'Update complete.';


GO
