using AutoMapper;
using CORE_BLL;
using CORE_BOL;
using CORE_BOL.Entities;
using CORE_DLL;
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Http;
using Microsoft.AspNetCore.Mvc;
using Newtonsoft.Json;
using Newtonsoft.Json.Linq;
using QRCoder;
using System;
using System.Collections.Generic;
using System.Data;
using System.Drawing;
using System.IO;
using System.Linq;
using System.Net.Http;
using System.Threading.Tasks;

namespace ARMS.Areas.PropertyTax.Controllers
{
    [Area("PropertyTax")]
    [Authorize]
    public class PropertyTaxsController : Controller
    {
        private readonly tt_dbContext _context;
        private readonly IMapper _mapper;
        ICommonFunction _CommonRepo = new CommonFunctionBLL();
        readonly IPropertyTax _repo = new PropertyTaxBLL();

        public PropertyTaxsController(tt_dbContext context)
        {
            _context = context;
        }
        [Authorize]
        [Route("PropertyTax/PropertyTaxs")]
        public IActionResult Index()
        {
            return View();
        }
        [Authorize]
        [Route("PropertyTax/PropertyTaxs/GetLandOwnershipDetail")]
        public List<LandOwneshipModel> GetLandOwnershipDetail( int TaxPayerId)
        {
            return _repo.GetLandOwnershipDetail(TaxPayerId).ToList();
        }
        [Authorize]
        [Route("Property/PropertyTaxs/GetTaxPayerProfile")]
        public List<LandOwneshipModel> FetchTaxPayerByCID(string Cid, string Ttin, string PlotNo, string ThramNo)
        {
            return  _repo.FetchTaxPayerByCID(Cid, Ttin, PlotNo,ThramNo).ToList();
        }
        [Authorize]
        [Route("PropertyTax/PropertyTaxs/GetLandTaxDetail")]
        public async Task<List<LandOwneshipModel>> GetLandTaxDetail(int LandOwnershipId)
        {
            return (List<LandOwneshipModel>)await _repo.GetLandTaxDetail(LandOwnershipId);
        }


        [Authorize]
        [Route("PropertyTax/PropertyTaxs/GetBuildingTaxDetail")]
        public List<BuildingTaxVM> GetBuildingTaxDetail(int LandOwnershipId)
        {
            return _repo.GetBuildingTaxDetail(LandOwnershipId).ToList();
        }
        [Authorize]
        [HttpPost]
        [Route("PropertyTax/PropertyTaxs/GeneratePropertyTax")]
        public JsonResult GenerateLandTax([FromBody] List<LedgerDemandVM> json_data)
        {
            
            //Check for NULL.  
            if (json_data == null)
            {
                json_data = new List<LedgerDemandVM>();
            }
            long returnvalue = 0;
            LedgerDemandVM obj = new LedgerDemandVM();
            //Loop and insert records. 
            foreach (LedgerDemandVM item in json_data)
            {
                obj.TaxId = item.TaxId;
                obj.TaxIdUD = item.TaxIdUD;
                obj.StructureAvailable = item.StructureAvailable;
                obj.TaxPayerId = item.TaxPayerId;
                obj.LandDetailId = item.LandDetailId;
                obj.LandOwnerShipId = item.LandOwnerShipId;
                //obj.FinancialYearId = item.FinancialYearId;
                obj.CalendarYearId = item.CalendarYearId;
                obj.TotalAmount = item.TotalAmount;
                obj.TotalAmountUD = item.TotalAmountUD;
                obj.CreatedBy = Convert.ToInt32(HttpContext.Session.GetInt32("UserId"));
                obj.CreatedOn = DateTime.Now;
                returnvalue = _repo.CreateLandTax(obj);
            }
          

            return Json(returnvalue);

        }
        [Authorize]
        [HttpPost]
        [Route("PropertyTax/PropertyTaxs/GenerateUnitTax")]
        public JsonResult GenerateUnitTax([FromBody] List<LedgerDemandVM> json_data)
        {

            //Check for NULL.  
            if (json_data == null)
            {
                json_data = new List<LedgerDemandVM>();
            }
            long returnvalue = 0;
            LedgerDemandVM obj = new LedgerDemandVM();
            //Loop and insert records. 
            foreach (LedgerDemandVM item in json_data)
            {
                
                obj.DemandNoId = item.DemandNoId;
                //obj.TransactionId = item.TransactionId;
                //obj.TaxId = item.TaxId;
                //obj.FinancialYearId = item.FinancialYearId;
                //obj.CalendarYearId = item.CalendarYearId;
                obj.TaxId = item.TaxId;
                obj.TotalAmount = item.TotalAmount;

                obj.GarbageTaxId = item.GarbageTaxId;
                obj.GarbageTax = item.GarbageTax;

                obj.StreetLightTaxId = item.StreetLightTaxId;
                obj.StreetLightTax = item.StreetLightTax;
                obj.LandOwnerShipId = item.LandOwnerShipId;
                obj.CreatedBy = Convert.ToInt32(HttpContext.Session.GetInt32("UserId"));
                obj.CreatedOn = DateTime.Now;
                returnvalue = _repo.GenerateUnitTax(obj);
            }

                return Json(returnvalue);
         

        }
        [Authorize]
        [HttpGet]
        [Route("PropertyTax/PropertyTaxs/GetGeneratedDemand")]
        public List<LedgerDemandVM> GetGeneratedDemand(long DemandNoId)
        {
            return _repo.GetGeneratedDemand(DemandNoId).ToList();
        }
        [Authorize]
        [HttpGet]
        [Route("PropertyTax/PropertyTaxs/PopulateCalendarYear")]
        public List<CommonFunctionModel> PopulateCalendarYear()
        {          
            return _CommonRepo.SelectListCalendarYear().ToList();

        }
        [Authorize]
        [HttpGet]
        [Route("PropertyTax/PropertyTaxs/CheckDuplicateTax")]
        public List<LedgerDemandVM> CheckDuplicateTax(int TaxPayerId, int LandDetailId, int CalendarYearId)
        {
            return _repo.CheckDuplicateTax(TaxPayerId, LandDetailId, CalendarYearId).ToList();
        }
        [Authorize]
        [HttpGet]
        [Route("PropertyTax/PropertyTaxs/lasttaxpaid")]
        public List<LedgerDemandVM> lasttaxpaid(int LandOwnershipId)
        {
            return _repo.lasttaxpaid(LandOwnershipId).ToList();
        }
        [Authorize]
        [HttpGet]
        [Route("PropertyTax/PropertyTaxs/GenerateAllPropertyTaxes")]
        public IActionResult GenerateAllPropertyTaxes()
        {
            return View();
        }

        [Authorize]
        [HttpGet]
        [Route("PropertyTax/PropertyTaxs/CheckStructureAvailable")]
        public List<LedgerDemandVM> CheckStructureAvailable(int LandOwnershipId)
        {
            return _repo.CheckStructureAvailable(LandOwnershipId).ToList();
        }
    }
}
