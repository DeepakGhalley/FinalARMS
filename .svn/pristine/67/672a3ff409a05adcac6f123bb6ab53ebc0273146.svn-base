/*
Deployment script for tt_db

This code was generated by a tool.
Changes to this file may cause incorrect behavior and will be lost if
the code is regenerated.
*/

GO
SET ANSI_NULLS, ANSI_PADDING, ANSI_WARNINGS, ARITHABORT, CONCAT_NULL_YIELDS_NULL, QUOTED_IDENTIFIER ON;

SET NUMERIC_ROUNDABORT OFF;


GO
:setvar DatabaseName "tt_db"
:setvar DefaultFilePrefix "tt_db"
:setvar DefaultDataPath "C:\Program Files\Microsoft SQL Server\MSSQL15.REVENUE\MSSQL\DATA\"
:setvar DefaultLogPath "C:\Program Files\Microsoft SQL Server\MSSQL15.REVENUE\MSSQL\DATA\"

GO
:on error exit
GO
/*
Detect SQLCMD mode and disable script execution if SQLCMD mode is not supported.
To re-enable the script after enabling SQLCMD mode, execute the following:
SET NOEXEC OFF; 
*/
:setvar __IsSqlCmdEnabled "True"
GO
IF N'$(__IsSqlCmdEnabled)' NOT LIKE N'True'
    BEGIN
        PRINT N'SQLCMD mode must be enabled to successfully execute this script.';
        SET NOEXEC ON;
    END


GO
USE [$(DatabaseName)];


GO
PRINT N'Dropping Default Constraint [dbo].[DF__tmp_ms_xx__noOfU__1DE63FD0]...';


GO
ALTER TABLE [dbo].[trnWaterConnection] DROP CONSTRAINT [DF__tmp_ms_xx__noOfU__1DE63FD0];


GO
PRINT N'Dropping Foreign Key [dbo].[FK_trnWaterMeterReading_ToTable]...';


GO
ALTER TABLE [dbo].[trnWaterMeterReading] DROP CONSTRAINT [FK_trnWaterMeterReading_ToTable];


GO
PRINT N'Dropping Foreign Key [dbo].[FK_trnWaterConnection_ToTable_3]...';


GO
ALTER TABLE [dbo].[trnWaterConnection] DROP CONSTRAINT [FK_trnWaterConnection_ToTable_3];


GO
PRINT N'Dropping Foreign Key [dbo].[FK_trnWaterConnection_ToTable_4]...';


GO
ALTER TABLE [dbo].[trnWaterConnection] DROP CONSTRAINT [FK_trnWaterConnection_ToTable_4];


GO
PRINT N'Dropping Foreign Key [dbo].[FK_trnWaterConnection_ToTable_5]...';


GO
ALTER TABLE [dbo].[trnWaterConnection] DROP CONSTRAINT [FK_trnWaterConnection_ToTable_5];


GO
PRINT N'Dropping Foreign Key [dbo].[FK_trnWaterConnection_ToTable_6]...';


GO
ALTER TABLE [dbo].[trnWaterConnection] DROP CONSTRAINT [FK_trnWaterConnection_ToTable_6];


GO
PRINT N'Dropping Foreign Key [dbo].[FK_trnWaterConnection_ToTable_7]...';


GO
ALTER TABLE [dbo].[trnWaterConnection] DROP CONSTRAINT [FK_trnWaterConnection_ToTable_7];


GO
PRINT N'Dropping Foreign Key [dbo].[FK_trnWaterConnection_ToTable_9]...';


GO
ALTER TABLE [dbo].[trnWaterConnection] DROP CONSTRAINT [FK_trnWaterConnection_ToTable_9];


GO
PRINT N'Dropping Foreign Key [dbo].[FK_trnWaterConnection_ToTable_1]...';


GO
ALTER TABLE [dbo].[trnWaterConnection] DROP CONSTRAINT [FK_trnWaterConnection_ToTable_1];


GO
PRINT N'Dropping Foreign Key [dbo].[FK_trnWaterConnection_ToTable_2]...';


GO
ALTER TABLE [dbo].[trnWaterConnection] DROP CONSTRAINT [FK_trnWaterConnection_ToTable_2];


GO
PRINT N'Dropping Foreign Key [dbo].[FK_trnWaterConnection_ToTable]...';


GO
ALTER TABLE [dbo].[trnWaterConnection] DROP CONSTRAINT [FK_trnWaterConnection_ToTable];


GO
PRINT N'Dropping Foreign Key [dbo].[FK_trnWaterConnection_ToTable_10]...';


GO
ALTER TABLE [dbo].[trnWaterConnection] DROP CONSTRAINT [FK_trnWaterConnection_ToTable_10];


GO
PRINT N'Dropping Foreign Key [dbo].[FK_trnWaterConnection_ToTable_8]...';


GO
ALTER TABLE [dbo].[trnWaterConnection] DROP CONSTRAINT [FK_trnWaterConnection_ToTable_8];


GO
PRINT N'Starting rebuilding table [dbo].[trnWaterConnection]...';


GO
BEGIN TRANSACTION;

SET TRANSACTION ISOLATION LEVEL SERIALIZABLE;

SET XACT_ABORT ON;

CREATE TABLE [dbo].[tmp_ms_xx_trnWaterConnection] (
    [trnWaterConnectionId]    BIGINT          IDENTITY (1, 1) NOT NULL,
    [landDetailId]            INT             NOT NULL,
    [waterConnectionStatusId] INT             NOT NULL,
    [waterMeterNo]            VARCHAR (145)   NOT NULL,
    [waterMeterTypeId]        INT             NOT NULL,
    [consumerNo]              VARCHAR (145)   NOT NULL,
    [applicationDate]         DATE            NOT NULL,
    [sewerageConnection]      BIT             NOT NULL,
    [waterConnectionTypeId]   INT             NOT NULL,
    [waterLineTypeId]         INT             NOT NULL,
    [standardCosumption]      INT             NOT NULL,
    [createdBy]               INT             NOT NULL,
    [createdOn]               DATE            NOT NULL,
    [modifiedBy]              INT             NULL,
    [modifiedOn]              DATE            NULL,
    [billingAddress]          VARCHAR (100)   NOT NULL,
    [zoneId]                  INT             NOT NULL,
    [flatNo]                  VARCHAR (45)    NULL,
    [initialReading]          DECIMAL (10, 2) NOT NULL,
    [organisationName]        VARCHAR (450)   NULL,
    [isActive]                BIT             NOT NULL,
    [remarks]                 VARCHAR (450)   NULL,
    [reUse]                   BIT             NULL,
    [disconnectDate]          DATE            NULL,
    [noOfUnits]               INT             DEFAULT 1 NOT NULL,
    [ownerTypeId]             INT             NOT NULL,
    [changeTypeId]            SMALLINT        NULL,
    [reconnectionDate]        DATE            NULL,
    [sewarageConnectionDate]  DATE            NULL,
    [sewarageConnectedBy]     INT             NULL,
    [primaryMobileNo]         VARCHAR (8)     NOT NULL,
    [secondaryMobileNo]       VARCHAR (8)     NULL,
    [workLevelId]             INT             NOT NULL,
    [transactionId]           BIGINT          NOT NULL,
    [isPermanentDisconnect]   BIT             NULL,
    [approvalStatusId]        BIT             NULL,
    [landOwnershipId]         INT             NULL,
    [g2cApplicationNo]        VARCHAR (300)   NULL,
    [readingDate]             DATE            NULL,
    [previousReadingDate]     DATE            NULL,
    [previousReading]         INT             NULL,
    [oldWaterConnectionId]    INT             NULL,
    [isPermanent]             BIT             NULL,
    PRIMARY KEY CLUSTERED ([trnWaterConnectionId] ASC)
);

IF EXISTS (SELECT TOP 1 1 
           FROM   [dbo].[trnWaterConnection])
    BEGIN
        SET IDENTITY_INSERT [dbo].[tmp_ms_xx_trnWaterConnection] ON;
        INSERT INTO [dbo].[tmp_ms_xx_trnWaterConnection] ([trnWaterConnectionId], [landDetailId], [waterConnectionStatusId], [waterMeterNo], [waterMeterTypeId], [consumerNo], [applicationDate], [sewerageConnection], [waterConnectionTypeId], [waterLineTypeId], [standardCosumption], [createdBy], [createdOn], [modifiedBy], [modifiedOn], [billingAddress], [zoneId], [flatNo], [initialReading], [organisationName], [isActive], [remarks], [reUse], [disconnectDate], [noOfUnits], [ownerTypeId], [changeTypeId], [reconnectionDate], [sewarageConnectionDate], [sewarageConnectedBy], [primaryMobileNo], [secondaryMobileNo], [workLevelId], [transactionId], [isPermanentDisconnect], [approvalStatusId], [landOwnershipId], [g2cApplicationNo], [readingDate], [previousReadingDate], [previousReading], [oldWaterConnectionId], [isPermanent])
        SELECT   [trnWaterConnectionId],
                 [landDetailId],
                 [waterConnectionStatusId],
                 [waterMeterNo],
                 [waterMeterTypeId],
                 [consumerNo],
                 [applicationDate],
                 [sewerageConnection],
                 [waterConnectionTypeId],
                 [waterLineTypeId],
                 [standardCosumption],
                 [createdBy],
                 [createdOn],
                 [modifiedBy],
                 [modifiedOn],
                 [billingAddress],
                 [zoneId],
                 [flatNo],
                 [initialReading],
                 [organisationName],
                 [isActive],
                 [remarks],
                 [reUse],
                 [disconnectDate],
                 [noOfUnits],
                 [ownerTypeId],
                 [changeTypeId],
                 [reconnectionDate],
                 [sewarageConnectionDate],
                 [sewarageConnectedBy],
                 [primaryMobileNo],
                 [secondaryMobileNo],
                 [workLevelId],
                 [transactionId],
                 [isPermanentDisconnect],
                 [approvalStatusId],
                 [landOwnershipId],
                 [g2cApplicationNo],
                 [readingDate],
                 [previousReadingDate],
                 [previousReading],
                 [oldWaterConnectionId],
                 [isPermanent]
        FROM     [dbo].[trnWaterConnection]
        ORDER BY [trnWaterConnectionId] ASC;
        SET IDENTITY_INSERT [dbo].[tmp_ms_xx_trnWaterConnection] OFF;
    END

DROP TABLE [dbo].[trnWaterConnection];

EXECUTE sp_rename N'[dbo].[tmp_ms_xx_trnWaterConnection]', N'trnWaterConnection';

COMMIT TRANSACTION;

SET TRANSACTION ISOLATION LEVEL READ COMMITTED;


GO
PRINT N'Creating Foreign Key [dbo].[FK_trnWaterMeterReading_ToTable]...';


GO
ALTER TABLE [dbo].[trnWaterMeterReading] WITH NOCHECK
    ADD CONSTRAINT [FK_trnWaterMeterReading_ToTable] FOREIGN KEY ([trnWaterConnectionId]) REFERENCES [dbo].[trnWaterConnection] ([trnWaterConnectionId]);


GO
PRINT N'Creating Foreign Key [dbo].[FK_trnWaterConnection_ToTable_3]...';


GO
ALTER TABLE [dbo].[trnWaterConnection] WITH NOCHECK
    ADD CONSTRAINT [FK_trnWaterConnection_ToTable_3] FOREIGN KEY ([waterConnectionTypeId]) REFERENCES [dbo].[mstWaterConnectionType] ([waterConnectionTypeId]);


GO
PRINT N'Creating Foreign Key [dbo].[FK_trnWaterConnection_ToTable_4]...';


GO
ALTER TABLE [dbo].[trnWaterConnection] WITH NOCHECK
    ADD CONSTRAINT [FK_trnWaterConnection_ToTable_4] FOREIGN KEY ([waterLineTypeId]) REFERENCES [dbo].[mstWaterLineType] ([waterLineTypeId]);


GO
PRINT N'Creating Foreign Key [dbo].[FK_trnWaterConnection_ToTable_5]...';


GO
ALTER TABLE [dbo].[trnWaterConnection] WITH NOCHECK
    ADD CONSTRAINT [FK_trnWaterConnection_ToTable_5] FOREIGN KEY ([zoneId]) REFERENCES [dbo].[mstZone] ([zoneId]);


GO
PRINT N'Creating Foreign Key [dbo].[FK_trnWaterConnection_ToTable_6]...';


GO
ALTER TABLE [dbo].[trnWaterConnection] WITH NOCHECK
    ADD CONSTRAINT [FK_trnWaterConnection_ToTable_6] FOREIGN KEY ([ownerTypeId]) REFERENCES [dbo].[enumOwnerType] ([ownerTypeId]);


GO
PRINT N'Creating Foreign Key [dbo].[FK_trnWaterConnection_ToTable_7]...';


GO
ALTER TABLE [dbo].[trnWaterConnection] WITH NOCHECK
    ADD CONSTRAINT [FK_trnWaterConnection_ToTable_7] FOREIGN KEY ([workLevelId]) REFERENCES [dbo].[enumWorkLevel] ([workLevelId]);


GO
PRINT N'Creating Foreign Key [dbo].[FK_trnWaterConnection_ToTable_9]...';


GO
ALTER TABLE [dbo].[trnWaterConnection] WITH NOCHECK
    ADD CONSTRAINT [FK_trnWaterConnection_ToTable_9] FOREIGN KEY ([landOwnershipId]) REFERENCES [dbo].[tblLandOwnershipDetail] ([landOwnershipId]);


GO
PRINT N'Creating Foreign Key [dbo].[FK_trnWaterConnection_ToTable_1]...';


GO
ALTER TABLE [dbo].[trnWaterConnection] WITH NOCHECK
    ADD CONSTRAINT [FK_trnWaterConnection_ToTable_1] FOREIGN KEY ([waterMeterTypeId]) REFERENCES [dbo].[mstWaterMeterType] ([waterMeterTypeId]);


GO
PRINT N'Creating Foreign Key [dbo].[FK_trnWaterConnection_ToTable_2]...';


GO
ALTER TABLE [dbo].[trnWaterConnection] WITH NOCHECK
    ADD CONSTRAINT [FK_trnWaterConnection_ToTable_2] FOREIGN KEY ([waterConnectionStatusId]) REFERENCES [dbo].[enumWaterConnectionStatus] ([waterConnectionStatusId]);


GO
PRINT N'Creating Foreign Key [dbo].[FK_trnWaterConnection_ToTable]...';


GO
ALTER TABLE [dbo].[trnWaterConnection] WITH NOCHECK
    ADD CONSTRAINT [FK_trnWaterConnection_ToTable] FOREIGN KEY ([landDetailId]) REFERENCES [dbo].[mstLandDetail] ([landDetailId]);


GO
PRINT N'Creating Foreign Key [dbo].[FK_trnWaterConnection_ToTable_10]...';


GO
ALTER TABLE [dbo].[trnWaterConnection] WITH NOCHECK
    ADD CONSTRAINT [FK_trnWaterConnection_ToTable_10] FOREIGN KEY ([oldWaterConnectionId]) REFERENCES [dbo].[mstWaterConnection] ([waterConnectionId]);


GO
PRINT N'Creating Foreign Key [dbo].[FK_trnWaterConnection_ToTable_8]...';


GO
ALTER TABLE [dbo].[trnWaterConnection] WITH NOCHECK
    ADD CONSTRAINT [FK_trnWaterConnection_ToTable_8] FOREIGN KEY ([transactionId]) REFERENCES [dbo].[tblTransactionDetail] ([transactionId]);


GO
PRINT N'Checking existing data against newly created constraints';


GO
USE [$(DatabaseName)];


GO
ALTER TABLE [dbo].[trnWaterMeterReading] WITH CHECK CHECK CONSTRAINT [FK_trnWaterMeterReading_ToTable];

ALTER TABLE [dbo].[trnWaterConnection] WITH CHECK CHECK CONSTRAINT [FK_trnWaterConnection_ToTable_3];

ALTER TABLE [dbo].[trnWaterConnection] WITH CHECK CHECK CONSTRAINT [FK_trnWaterConnection_ToTable_4];

ALTER TABLE [dbo].[trnWaterConnection] WITH CHECK CHECK CONSTRAINT [FK_trnWaterConnection_ToTable_5];

ALTER TABLE [dbo].[trnWaterConnection] WITH CHECK CHECK CONSTRAINT [FK_trnWaterConnection_ToTable_6];

ALTER TABLE [dbo].[trnWaterConnection] WITH CHECK CHECK CONSTRAINT [FK_trnWaterConnection_ToTable_7];

ALTER TABLE [dbo].[trnWaterConnection] WITH CHECK CHECK CONSTRAINT [FK_trnWaterConnection_ToTable_9];

ALTER TABLE [dbo].[trnWaterConnection] WITH CHECK CHECK CONSTRAINT [FK_trnWaterConnection_ToTable_1];

ALTER TABLE [dbo].[trnWaterConnection] WITH CHECK CHECK CONSTRAINT [FK_trnWaterConnection_ToTable_2];

ALTER TABLE [dbo].[trnWaterConnection] WITH CHECK CHECK CONSTRAINT [FK_trnWaterConnection_ToTable];

ALTER TABLE [dbo].[trnWaterConnection] WITH CHECK CHECK CONSTRAINT [FK_trnWaterConnection_ToTable_10];

ALTER TABLE [dbo].[trnWaterConnection] WITH CHECK CHECK CONSTRAINT [FK_trnWaterConnection_ToTable_8];


GO
PRINT N'Update complete.';


GO
