@model List<CORE_BOL.AssetRegisterVM>

@{
    ViewData["Title"] = "Index";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<link rel="stylesheet" href="~/plugins/sweetalert2/sweetalert2.js">
<div class="content-header">
    <div class="container-fluid">
        <div class="row mb-2">
            <div class="col-sm-6">
                <h1 class="m-0 text-dark"></h1>
                <!-- HIDDEN FIELDS HERE -->
                <input type="hidden" id="hdnAssetId" value="" />


                <!-- HIDDEN FIELDS HERE END -->
            </div><!-- /.col -->
            <div class="col-sm-6">
                <ol class="breadcrumb float-sm-right">
                    <li class="breadcrumb-item"><a asp-action="Index">Asset Register</a></li>
                    <li class="breadcrumb-item active">Asset Register Details</li>
                </ol>
            </div><!-- /.col -->
        </div><!-- /.row -->
    </div><!-- /.container-fluid -->
</div>
<!-- /.content-header -->


<div class="card card-info">
    @if (TempData["msg"] != null)
    {
        <div class="alert alert-success alert-dismissible">
            <button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button>
            <h5><i class="icon fas fa-check"></i> Alert!</h5>
            <p>@TempData["msg"]</p>
        </div>
    }

    <div class="card-header">
        <h3 class="card-title">Asset Register Details</h3>
    </div>
    <!-- /.card-header -->
    <div class="card-body">
        <p>
            <a asp-action="Create" class="btn btn-outline-danger btn-lg" title="Add New"><b><i class="fas fa-plus"></i> Add New</b> </a>
        </p><hr />
        <table id="example1" class="table table-bordered table-striped">
            <thead style="background-color:mediumaquamarine">
                <tr>
                    <th>#</th>
                    <th>Asset Code</th>
                    <th>Asset Name</th>
                    <th>Asset Status</th>
                    <th>Tertiary Account Head</th>

                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                @{int sl = 1; }

                @foreach (var item in Model)
                {
                    <tr>
                        <td>
                            @sl
                        </td>
                        <td>
                            @Html.DisplayFor(modelItem => item.AssetCode)
                        </td>
                        <td>
                            @Html.DisplayFor(modelItem => item.AssetName)
                        </td>
                        <td>
                            @Html.DisplayFor(modelItem => item.AssetStatusNames)
                        </td>
                        <td>
                            @Html.DisplayFor(modelItem => item.TertiaryAccountHeadNames)
                        </td>

                        <td style="text-align:center;">
                            <a asp-action="Edit" asp-route-id="@item.AssetId" title="EDIT"><i class="fas fa-edit"></i></a>
                            &nbsp;&nbsp;|&nbsp;&nbsp;<a asp-action="Details" asp-route-id="@item.AssetId" title="View"><i class="fas fa-eye"></i> </a>
                            &nbsp;&nbsp;|&nbsp;&nbsp;<a style="color: #007bff; cursor: pointer;" onclick="return displayFinancial(' @item.AssetId ',' @item.AssetName ');" title="Add Financial Details"><i class="fas fa-plus-circle"></i> Financial</a>
                            &nbsp;&nbsp;|&nbsp;&nbsp;<a style="color: #007bff; cursor: pointer;" onclick="return displayTechnical(@item.TertiaryAccountHeadId,@item.AssetId);" title="Add Technical Details"><i class="fas fa-plus-circle"></i> Technical</a>

                        </td>
                    </tr>
                    sl++;
                }
            </tbody>
        </table>
    </div>

</div>

<div class="card card-info" id="financialInfoDetail" style="display: none;">
    <div class="card-header">
        <h3 class="card-title">Financial Information Details for <label id="lblasset"></label></h3>
    </div>
    <div class="card-body">

        <div class="form-group row">
            <label class="col-sm-3 col-form-label">Procurement Order Ref. No.</label>
            <div class="col-sm-3">
                Procurement Order Ref. No.
            </div>
            <label class="col-sm-3 col-form-label">Procurement Order Date</label>
            <div class="col-sm-3">
                Procurement Order Date
            </div>

        </div>

    </div>
</div>


<div class="card card-info" id="financial" style="display: none;">
    <div class="card-header">
        <h3 class="card-title">Financial Information for <label id="lblasset"></label></h3>
    </div>
    <div class="card-body">

        <div class="form-group row">
            <label class="col-sm-3 col-form-label">Procurement Order Ref. No. <span style="font-weight: bold; color: red;">*</span></label>
            <div class="col-sm-3">
                <input class="form-control" id="ProcurementOrderRefNo" />
            </div>
            <label class="col-sm-3 col-form-label">Procurement Order Date <span style="font-weight: bold; color: red;">*</span></label>
            <div class="col-sm-3">
                <input class="form-control" type="date" placeholder="dd/mm/yyyy" id="ProcurementOrderDate" />
            </div>

        </div>

        <div class="form-group row">
            <label class="col-sm-3 col-form-label">Date of Procurement <span style="font-weight: bold; color: red;">*</span></label>
            <div class="col-sm-3">
                <input class="form-control" type="date" placeholder="dd/mm/yyyy" id="DateofProcurement" />
            </div>
            <label class="col-sm-3 col-form-label">Date of Commissioning <span style="font-weight: bold; color: red;">*</span></label>
            <div class="col-sm-3">
                <input class="form-control" type="date" placeholder="Enter Date" id="DateofCommissioning" />
            </div>

        </div>
        <div class="form-group row">
            <label class="col-sm-3 col-form-label">Useful Economic life (Years) <span style="font-weight: bold; color: red;">*</span></label>
            <div class="col-sm-3">
                <input class="form-control" onkeypress="return isNumberKey(this, event);" id="UsefulLife" />
            </div>
            <label class="col-sm-3 col-form-label">Cost of procurement (Nu) <span style="font-weight: bold; color: red;">*</span></label>
            <div class="col-sm-3">
                <input class="onlynum form-control" id="CostofProcurement" />
            </div>

        </div>

        <div class="form-group row">
            <label class="col-sm-3 col-form-label"></label>
            <div class="col-sm-9">
                <button type="button" class="btn btn-primary" id="SaveFinancial">Save</button>
                <button type="reset" id="btnCancel" class="btn btn-warning" onclick="cancel();">Cancel</button>
            </div>

        </div>
    </div>
</div>




<div class="card card-info" id="technical" style="display: none;">
    <div class="card-header">
        <h3 class="card-title">Technical Details</h3>
    </div>
    <div class="card-body">
        <table id="example111" class="table table-bordered table-striped">
            <thead style="background-color:mediumaquamarine">
                <tr>
                    <th style="display:none;"></th>
                    <th>Attribute Name</th>
                    <th>Value</th>
                    <th>Unit</th>
                </tr>
            </thead>
            <tbody id="myTechnicalbodyDetails">
            </tbody>
        </table>
        <br />
        <table id="example1" class="table table-bordered table-striped">
            <thead style="background-color:mediumaquamarine">
                <tr>
                    <th style="display:none;"></th>
                    <th>Attribute Name</th>
                    <th>Value</th>
                    <th>Unit</th>
                </tr>
            </thead>
            <tbody id="myTechnicalbody">
            </tbody>
        </table>

    </div>
    <div class="form-group row">
        <label class="col-sm-3 col-form-label"></label>
        <div class="col-sm-9">
            <button type="button" class="btn btn-primary" id="SaveTechnical">Save</button>
            <button type="reset" id="btnCancel" class="btn btn-warning" onclick="cancel();">Cancel</button>
        </div>

    </div>
</div>

<script src="~/plugins/jquery/jquery.min.js"></script>

<script>

    $(function () {
        $("#example1").DataTable({
            "responsive": true,
            "autoWidth": false,
        });
        $('#example2').DataTable({
            "paging": true,
            "lengthChange": false,
            "searching": false,
            "ordering": true,
            "info": true,
            "autoWidth": false,
            "responsive": true,
        });

        $('.onlynum').keypress(function (event) {
            if ((event.which != 46 || $(this).val().indexOf('.') != -1) && (event.which < 48 || event.which > 57)) {
                event.preventDefault();
            }
        });



    });

    function displayFinancial(assetid, assetname) {
        $('#financialInfoDetail').show(1000);  
        $('#financial').show(1000);
        $('#technical').hide(1000);

        $('html,body').animate({
            scrollTop: $("#financial").offset().top
        }, 'slow');

        $('#hdnAssetId').val(assetid);

        $('#lblasset').html(assetname);
    }

    function displayTechnical(tertiary_id, assetId) {

        $('#technical').show(1000);
        $('#financial').hide(1000);

        $('#hdnAssetId').val(assetId);
        //alert($('#hdnAssetId').val());

        $('html,body').animate({
            scrollTop: $("#technical").offset().top
        }, 'slow');

        // for already added display

        $.ajax({
                type: "POST",
                url: '@Url.Action("GetTechnical", "Assets")',
                data: {
                    id: parseInt(assetId)
                },
                success: function (data) {

                console.log(data);
                    $('#myTechnicalbodyDetails').empty();

                    if (data.length  0) {

                        $.each(data, function (key, value) {

                            $('#myTechnicalbodyDetails').append(
                                '<tr>'
                                + '<td>' + value.attributeName + '</td>'
                                + '<td>' + value.value + '</td>'
                                + '<td>' + value.measurementUnit + '</td>'

                                + '</tr>');


                        });

                    }
                    else {
                        $('#myTechnicalbodyDetails').append(
                            '<tr><td colspan="3" style="color: red;">No record found!</td></tr>');
                    }

                },
                    error: function () {
                    $('#img').hide();
                    alert('Error occured');
                    }
                });


        // -----------END-----------

        $('#img').show();

        $.ajax({
                type: "POST",
                url: '@Url.Action("GetTechnical", "Assets")',
                data: {
                    id: parseInt(tertiary_id)
                },
            success: function (data) {


                console.log(data);
                    $('#myTechnicalbody').empty();

                    if (data.length > 0) {
                        $('#img').hide();

                        $.each(data, function (key, value) {

                            $('#myTechnicalbody').append(
                                '<tr>'
                                + '<td style="display:none;"><input id="assetId_' + key + '" type="hidden" value="' + assetId + '" /><input id="assetAttributeId_' + key + '" type="hidden" value="' + value.assetAttributeId + '" /></td>'
                                + '<td>' + value.attributeName + '</td>'
                                + '<td><input type="text" id="attributeval_' + key + '" class="form-control" value="" /></td>'
                                + '<td> <select id="measurementUnitId_'+ key + '" class="form-control select2" ></select></td>'

                                + '</tr>');


                            getMeasurementUnit(value.assetAttributeId, key);

                        });

                    }
                    else {
                        $('#img').hide();
                    }

                },
                    error: function () {
                    $('#img').hide();
                    alert('Error occured');
                    }
                });
    }


    function getMeasurementUnit(assetattribute_id, key) {

        $.ajax({
                type: "POST",
                url: '@Url.Action("GetMeasurementUnit", "Assets")',
                data: {
                    AssetAttributeId: parseInt(assetattribute_id)
                },
                success: function (data) {

                    console.log(data);
                    $('#measurementUnitId_' + key).empty();

                    $('#measurementUnitId_' + key).append(
                    '<option value=0>--Please Select--</option>');

                    if (data.length > 0) {

                    for (var i = 0; i < data.length; i++) {
                        var newOption = $('<option value=' + data[i].value + '> '
                            + data[i].text
                        + ' </option>');
                        $('#measurementUnitId_' + key).append(newOption);
                    }


                }
                else {
                    //$('#img').hide();
                }

                },
                error: function () {
                    //$('#img').hide();
                    alert('Error occured');
                }
                });

    }




    function isNumberKey(txt, evt) {
        var charCode = (evt.which) ? evt.which : evt.keyCode;
        if (charCode == 46) {
            //Check if the text already contains the . character
            if (txt.value.indexOf('.') === -1) {
                return true;
            } else {
                return false;
            }
        } else {
            if (charCode > 31 &&
                (charCode < 48 || charCode > 57))
                return false;
        }
        return true;
    }

    function cancel() {
        $('#financial').hide(1000);
        $('#technical').hide(1000);
        $('html,body').animate({
            scrollTop: $("#technical").offset().top
        }, 'slow');

    }


    $("#SaveFinancial").click(function () {

        var myarray = [];
        var FinancialInformationVM = {};

        FinancialInformationVM.AssetId = parseInt($('#hdnAssetId').val());
        FinancialInformationVM.DateofProcurement = $("#DateofProcurement").val();
        FinancialInformationVM.DateofCommissioning = $("#DateofCommissioning").val();
        FinancialInformationVM.UsefulLife = parseFloat($("#UsefulLife").val());
        FinancialInformationVM.ProcurementOrderRefNo = $("#ProcurementOrderRefNo").val();
        FinancialInformationVM.ProcurementOrderDate = $("#ProcurementOrderDate").val();
        FinancialInformationVM.CostofProcurement = parseFloat($("#CostofProcurement").val());

        myarray.push(FinancialInformationVM);

        var json_data = JSON.stringify(myarray);
        console.log(json_data);

        $('#img').show();

        $.ajax({
            type: "POST",
            url: '@Url.Action("CreateFinancial", "Assets")',
            data: json_data,
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            success: function (response) {

                $('#img').hide();
                swal(response);
            },
            failure: function (response) {
                $('#img').hide();
                swal("Creation Failed");
            },
            error: function (response) {
                $('#img').hide();
                swal("Error while inserting");
            }
        });
    });




    $('#SaveTechnical').on('click', function () {

        var r = confirm("Do you want to submit technical details?");
        if (r == true) {
        } else {
            return false;
        }

        var index = 0; var flag = 0; var flag1 = 0;
        $('#example1 > tbody  > tr ').each(function () {
            var sa = $('#attributeval_' + parseInt(index)).val();
            var sb = $('#measurementUnitId_' + parseInt(index)).val();

            if (sa == "") {
                flag = 1;
            }
            if (sb == "0") {
                flag1 = 1;
            }
            index = index + 1
        });
        if (flag == 1) {
            alert("You have left some value fields empty. Please fill up the empty fields!");
            return false;
        }
        if (flag1 == 1) {
            alert("You have left some measurement fields empty. Please fill up the empty fields!");
            return false;
        }
         $.ajax({
                type: "POST",
                url: '@Url.Action("CheckDuplicateInformation", "Assets")',
                data: {

                    id: parseInt($('#hdnAssetId').val())

                },
                success: function (data) {

                    console.log(data);

                    if (data.length > 0) {
                       // alert($('#hdnAssetId').val());
                        $('#img').hide();

                        alert("The technical details for this asset is already added.!");
                        return false;
                    }
                    else {

                        var myarray = [];
                        for (i = 0; i < $("#example1 TBODY TR").length - 1; i++) {

                            var siobj = {};

                            siobj.AssetId = parseInt($("#assetId_" + i).val());
                            siobj.AssetAttributeId = parseInt($("#assetAttributeId_" + i).val());
                            siobj.MeasurementUnitId = parseInt($("#measurementUnitId_" + i).val());
                            siobj.Value = $("#attributeval_" + i).val();

                            myarray.push(siobj);
                        }

                        console.log(JSON.stringify(myarray));

                        //return false;
                        $.ajax({
                            contentType: "application/json; charset=utf-8",
                            dataType: "json",
                            url: '@Url.Action("CreateTechnicalInformation", "Assets")',
                            type: "POST",
                            data: JSON.stringify(myarray),
                            success: function (r) {
                                if (r > 0) {

                                    alert("Technical details saved successfully.");

                                    setTimeout(function () {
                                        $('.alert').fadeOut(1000);
                                        location.reload();
                                    }, 5000);
                                }
                                else {
                                    alert("Error saving Technical details.");
                                }

                            }
                        });
                    }
                 },
                 error: function () {
                     $('#img').hide();
                     alert('Error occured');
                 }

             });
    });


    //function saveme() {
    //    $('#img').show();
    //}
</script>