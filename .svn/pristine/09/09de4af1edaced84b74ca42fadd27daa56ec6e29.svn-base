@using CORE_BOL
@model WaterMeterReadingModel
@{
    ViewData["Title"] = "WaterMeterReadingEdit";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<!-- Content Header (Page header) -->
<div class="content-header">
    <div class="container-fluid">
        <div class="row mb-2">
            <div class="col-sm-6">
                <h1 class="m-0 text-dark"></h1>
            </div><!-- /.col -->
            <div class="col-sm-6">
                <ol class="breadcrumb float-sm-right">
                    <li class="breadcrumb-item"><a asp-action="Index">Water Transaction</a></li>
                    <li class="breadcrumb-item active">Water Payment Receipt</li>
                </ol>
            </div>
        </div>
    </div>
</div>

<form class="form-horizontal" method="get">
    <div class="card card-info">
        @if (TempData["msg"] != null)
        {
            <div class="alert alert-success alert-dismissible">
                <button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button>
                <h5><i class="icon fas fa-check"></i> Alert!</h5>
                <p>@TempData["msg"]</p>
            </div>
        }
        <div class="card-header">
            <h3 class="card-title">Search Details</h3>
        </div>
        <div class="card-body">
            <div class="row ">
                <div class="input-group col-4">
                    <label class="col-sm-6 col-form-label">Consumer No</label>
                    <input class="form-control col-sm-6" id="idConsumerno" />
                </div>
                <div class="input-group col-4">
                    <label class="col-sm-4 col-form-label">Year</label>
                    <select id="idYear" class="form-control col-sm-8 select2bs4"
                            asp-items="@(new SelectList (@ViewBag.Year,"Value","Text")) " value="0"></select>
                </div>
                <div class="input-group-append col-4">
                    <input type="button" value="search" class="btn btn-primary" onclick="return displayDetails();" />
                </div>
            </div>
        </div>
    </div>
</form>

<!--WATER METER READING DETAILS-->
<div class="card card-info" id="dvPaymentReceipt" style="display:none;">
    <div class="card-header">
        <h3 class="card-title">Payment Receipt</h3>
    </div>
    <div class="card-body table-responsive">
        <table class="table  table-bordered table-striped">
            <thead style="background-color:mediumaquamarine">
                <tr class="text-center">
                    <th>#</th>
                    <th>Consumer No</th>
                    <th>Meter No</th>
                    <th>Year</th>
                    <th>Month</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody id="mybody">
            </tbody>
        </table>
    </div>
</div>
<!--WATER PAYMENT RECEIPT-->
<div class="card card-info" id="idPayementReceipt" style="display:none;">
    <div class="card-header">
        <div class="card-title">Water Payment Receipt</div>
    </div>
    <div class="card-body" id="dvToPrint" style="background-color:whitesmoke">
        <table width="100%" style="border-collapse: collapse; font-size:10px; ">

            <tr><td></td></tr>
            <tr>
                <td colspan="4"><img src="~/dist/img/tt_logo.gif" height="80px" width="80px" /></td>

                <td align="right" ;><img id="qrDemandNo" height="80px" width="80px" /></td>

                @*<td><img src="../images/thimphuthromde.png" height="50px" width="50px" /></td>*@
            </tr>
            <tr><td colspan="5" style="font-size: 14px;" align="center"><b>Thimphu Thromde<br />Payment Receipt</b></td></tr>
            <tr>
                <td><strong>Receipt For :</strong></td>
                <td colspan="4">    <Label id="lblfor"></Label></td>

            </tr>

            <tr>
                <td style="width:85px; font-size: 10px;" colspan="1">
                    <strong>Invoice No :</strong>
                </td>
                <td style="width:85px; font-size: 10px;" align="left">
                    <Label id="lblInvoiceNo"></Label>
                </td>
                <td style="width:85px; font-size: 10px;" align="left">
                    <Label id="lblZonename"></Label>
                </td>
                <td align="left">
                    <strong>  Receipt No:</strong>
                </td>
                <td>
                    <Label id="lblreceiptno"></Label>
                </td>
            </tr>
            <tr>
                <td style="width:85px; font-size: 10px;">
                    <strong>  Demand Date:</strong>&nbsp;&nbsp;&nbsp;
                </td>
                <td style="width:85px; font-size: 10px;">
                    <Label id="lbldemandDate"></Label>
                </td>
                <td style="width:85px; font-size: 10px;">
                </td>
                <td style="width:85px; font-size: 10px;">
                    <strong>  Payment Date:</strong>&nbsp;
                </td>
                <td>
                    <Label id="lblpaymentdate"></Label>
                </td>
            </tr>
            <tr>
                <td>
                    <strong>Consumer No:</strong>&nbsp;

                </td>
                <td>
                    <Label id="lblconsumerno"></Label>
                    &nbsp;
                </td>
                <td></td>
                <td>  <strong>  Meter No:</strong></td>
                <td>

                    <Label id="lblmeterno"></Label>

                </td>
            </tr>

            <!--TABLE 1-->
            <tr style="background-color:grey; color:white;">
                <td class="text-center" style="border:1px solid dimgray; width:15%;"><b>#</b></td>
                <td class="text-left" style="border:1px solid dimgray; width:25%;"><b>Tax Name</b></td>
                <td style="border:1px solid dimgray; width:20%;"><b>Demand Amount</b></td>
                <td style="border:1px solid dimgray; width:20%;"><b>Exemption Amount</b></td>
                <td style="border:1px solid dimgray; width:20%;"><b>Total Amount</b></td>
            </tr>
            <tbody id="tblBody">
            </tbody>
            <tr>
                <td></td>
                <td></td>
                <td></td>
                <td class="text-right"><strong>Amount Paid:</strong></td>
                <td class="text-right">
                    <Label id="lblamountpayable"></Label>
                </td>
            </tr>
            <tr><td>&nbsp;</td></tr>
            <tr><td>&nbsp;</td></tr>
            <tr><td>&nbsp;</td></tr>
            <tr><td>&nbsp;</td></tr>
            <tr>
                <td></td>
                <td></td>
                <td></td>
                <td class="text-right"><strong>Collected By:</strong></td>
                <td class="text-right">
                    <Label id="lblUser"></Label>
                </td>
            </tr>
        </table>
       
    </div>
    <div class="row m-2">
        <div class="input-group-append col-6">
            <input type="button" value="Done" class="btn btn-primary" onclick="return HideDivs();" />&nbsp;&nbsp;
            <button class="btn btn-warning" onclick="return PrintReceipt();"><i class="fas fa-print"></i>Print</button>
        </div>
    </div>
</div>

<script>
    //WATER METER READING DETAILS
    function displayDetails() {
        var ConsumerNo = $('#idConsumerno').val();
        var Year = $('#idYear').val();

        if ($('#idConsumerno').val() == "" && $('#qrDemandNo').val() == "") {
            swal('Please Enter Consumer No!');
            return false;
        }

        $.ajax({
            type: "GET",
            url: '@Url.Action("GetWaterPaymentDetails", "WaterMeterReadings")',
            data: {
                ConsumerNo: ConsumerNo,
                Year: Year
            },
            success: function (data) {
                $('#mybody').empty();
                console.log(data);
                if (data.length > 0) {
                    $.each(data, function (key, value) {
                        $('#dvPaymentReceipt').show(1000);

                        //const c = new Date(value.month);
                        //const Month = (c.toLocaleString('default', { month: 'long' }))
                       
                        $('#mybody').append(
                            '<tr class="text-center">'
                            + '<td>' + (key + 1) + '</td>'
                            + '<td>' + value.consumerNo + '</td>'
                            + '<td>' + value.waterMeterNo + '</td>'
                            + '<td>' + value.year + '</td>'
                            + '<td>' + value.month + '</td>'
                            + '<td>'
                            + '<a style = "color: #007bff; cursor: pointer;" title = "Save" onclick = "return ViewPaymentDetails(' + value.transactionId + ',' + value.isPaymentMade + ',\'' + value.month + '\',\'' + value.consumerNo + '\',\'' + value.waterMeterNo + '\',' + value.year +');" > <i class="fas fa-eye"></i> View Receipt</a >'
                            + '</td>'
                            + '</tr>');

                    });
                    $('#qrDemandNo').attr('src', `data:image/png;base64,${data[0].qrImage}`);

                } else {
                    $('#dvPaymentReceipt').hide(1000);
                    $('#idPayementReceipt').hide(1000);

                    swal('No Record Found!');
                }
            },

            error: function () {
                alert('error');
            }
        });
    }

    function ViewPaymentDetails(transactionId, isPaymentMade, month, ConsumerNo, WaterMeterNo,myYr) {
        //alert(transactionId);
        //alert(month);
        //alert(isPaymentMade);

        $('#lblconsumerno').html(ConsumerNo);
        $('#lblmeterno').html(WaterMeterNo);

        if (isPaymentMade == false) {
            swal("Please Make a Payment for the month of"+ " " + month);
            $('#idPayementReceipt').hide(1000);

        } else {
            $('#idPayementReceipt').toggle(1000);
        }
        //Water Payment Details Head
        $.ajax({
            type: "GET",
            url: '@Url.Action("GetWaterPaymentInfo", "WaterMeterReadings")',
            data: {
                TransactionId: transactionId
            },
            success: function (data) {
                var my = month + ', ' + myYr;

                $('#lblfor').text(my);
              
                
                console.log(data);
                if (data.length > 0) {

                    
                    var BillDate = data[0].billingDate;
                    var DemandNo = data[0].demandNo;
                    var PaymentDate = data[0].paymentDate;
                    var ReceiptNo = data[0].receiptNo;

                    $('#lblInvoiceNo').text(DemandNo);
                    $('#lbldemandDate').text(BillDate);
                    $('#lblpaymentdate').text(PaymentDate);
                    $('#lblreceiptno').text(ReceiptNo);
                }
            },

            error: function () {
                alert('error');
            }
        });

        //Water Payment Details Table
        $.ajax({
            type: "GET",
            url: '@Url.Action("FetchWaterPaymentInfo", "WaterMeterReadings")',
            data: {
                TransactionId: transactionId
            },
            success: function (data) {
                $('#tblBody').empty();
                console.log(data);
                if (data.length > 0) {
                    $.each(data, function (key, value) {

                        $('#tblBody').append(
                            '<tr style="border:1px solid dimgray;">'
                            + '<td class="text-center" style="border:1px solid dimgray;">' + (key + 1) + '</td>'
                            + '<td class="text-left" style="border:1px solid dimgray;">' + value.taxName + '</td>'
                            + '<td class="text-right" style="border:1px solid dimgray;">' + value.demandAmount + '</td>'
                            + '<td class="text-right" style="border:1px solid dimgray;">' + value.exemptionAmount + '</td>'
                            + '<td class="text-right" style="border:1px solid dimgray;">' + value.totalAmount + '</td>'
                            + '</tr>');
                        $('#lblamountpayable').text(value.amountPayable);
                        $('#lblUser').text(value.userName);

                    });

                }
            },

            error: function () {
                alert('error');
            }
        });

    }

    function PrintReceipt() {
        var today = new Date();
        var date = ("0" + today.getDate()).slice(-2) + '/' + ("0" + (today.getMonth() + 1)).slice(-2) + '/' + today.getFullYear()


        var tableToPrint = document.getElementById("dvToPrint");
        newWin = window.open("");
        newWin.document.write(tableToPrint.outerHTML);
        newWin.print();
        newWin.close();
    }

    function HideDivs() {
        $('#idPayementReceipt').hide(1000);
        //$('#dvPaymentReceipt').hide(1000);

    }
</script>