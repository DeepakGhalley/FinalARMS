/*
Deployment script for tt_db

This code was generated by a tool.
Changes to this file may cause incorrect behavior and will be lost if
the code is regenerated.
*/

GO
SET ANSI_NULLS, ANSI_PADDING, ANSI_WARNINGS, ARITHABORT, CONCAT_NULL_YIELDS_NULL, QUOTED_IDENTIFIER ON;

SET NUMERIC_ROUNDABORT OFF;


GO
:setvar DatabaseName "tt_db"
:setvar DefaultFilePrefix "tt_db"
:setvar DefaultDataPath "C:\Program Files\Microsoft SQL Server\MSSQL14.MSSQLSERVER\MSSQL\DATA\"
:setvar DefaultLogPath "C:\Program Files\Microsoft SQL Server\MSSQL14.MSSQLSERVER\MSSQL\DATA\"

GO
:on error exit
GO
/*
Detect SQLCMD mode and disable script execution if SQLCMD mode is not supported.
To re-enable the script after enabling SQLCMD mode, execute the following:
SET NOEXEC OFF; 
*/
:setvar __IsSqlCmdEnabled "True"
GO
IF N'$(__IsSqlCmdEnabled)' NOT LIKE N'True'
    BEGIN
        PRINT N'SQLCMD mode must be enabled to successfully execute this script.';
        SET NOEXEC ON;
    END


GO
USE [$(DatabaseName)];


GO
PRINT N'Dropping unnamed constraint on [dbo].[tblWaterMeterReading]...';


GO
ALTER TABLE [dbo].[tblWaterMeterReading] DROP CONSTRAINT [DF__tblWaterM__isRea__56F3D4A3];


GO
PRINT N'Dropping [dbo].[FK_tblWaterMeterReading_ToTable_3]...';


GO
ALTER TABLE [dbo].[tblWaterMeterReading] DROP CONSTRAINT [FK_tblWaterMeterReading_ToTable_3];


GO
PRINT N'Dropping [dbo].[FK_tblWaterMeterReading_ToTable]...';


GO
ALTER TABLE [dbo].[tblWaterMeterReading] DROP CONSTRAINT [FK_tblWaterMeterReading_ToTable];


GO
PRINT N'Dropping [dbo].[FK_tblWaterMeterReading_ToTable_1]...';


GO
ALTER TABLE [dbo].[tblWaterMeterReading] DROP CONSTRAINT [FK_tblWaterMeterReading_ToTable_1];


GO
PRINT N'Dropping [dbo].[FK_tblWaterMeterReading_ToTable_2]...';


GO
ALTER TABLE [dbo].[tblWaterMeterReading] DROP CONSTRAINT [FK_tblWaterMeterReading_ToTable_2];


GO
PRINT N'Dropping [dbo].[FK_tblWaterMeterReading_ToTable_4]...';


GO
ALTER TABLE [dbo].[tblWaterMeterReading] DROP CONSTRAINT [FK_tblWaterMeterReading_ToTable_4];


GO
PRINT N'Starting rebuilding table [dbo].[tblWaterMeterReading]...';


GO
BEGIN TRANSACTION;

SET TRANSACTION ISOLATION LEVEL SERIALIZABLE;

SET XACT_ABORT ON;

CREATE TABLE [dbo].[tmp_ms_xx_tblWaterMeterReading] (
    [waterMeterReadingId]     INT             IDENTITY (1, 1) NOT NULL,
    [waterConnectionId]       INT             NOT NULL,
    [waterConnectionTypeId]   INT             NOT NULL,
    [waterMeterTypeId]        INT             NOT NULL,
    [waterLineTypeId]         INT             NOT NULL,
    [waterConnectionStatusId] INT             NOT NULL,
    [bucid]                   INT             NULL,
    [zoneId]                  INT             NOT NULL,
    [reading]                 INT             NOT NULL,
    [isRead]                  BIT             DEFAULT 0 NOT NULL,
    [previousReading]         INT             NOT NULL,
    [previousReadingDate]     DATE            NOT NULL,
    [readBy]                  INT             NOT NULL,
    [readingDate]             DATE            NOT NULL,
    [noOfUnit]                INT             NOT NULL,
    [consumption]             INT             NOT NULL,
    [standardConsumption]     DECIMAL (18, 2) NULL,
    [isPermanentConnection]   BIT             NOT NULL,
    [sewerage]                BIT             NOT NULL,
    [solidWaste]              BIT             NOT NULL,
    [remarks]                 VARCHAR (250)   NULL,
    [billingAddress]          VARCHAR (350)   NOT NULL,
    [transactionId]           BIGINT          NULL,
    [primaryMobileNo]         VARCHAR (150)   NOT NULL,
    [secondaryMobileNo]       VARCHAR (150)   NULL,
    PRIMARY KEY CLUSTERED ([waterMeterReadingId] ASC)
);

IF EXISTS (SELECT TOP 1 1 
           FROM   [dbo].[tblWaterMeterReading])
    BEGIN
        SET IDENTITY_INSERT [dbo].[tmp_ms_xx_tblWaterMeterReading] ON;
        INSERT INTO [dbo].[tmp_ms_xx_tblWaterMeterReading] ([waterMeterReadingId], [waterConnectionId], [waterConnectionTypeId], [waterMeterTypeId], [waterLineTypeId], [waterConnectionStatusId], [bucid], [reading], [previousReading], [previousReadingDate], [readBy], [readingDate], [noOfUnit], [consumption], [standardConsumption], [isPermanentConnection], [sewerage], [solidWaste], [remarks], [billingAddress], [transactionId], [primaryMobileNo], [secondaryMobileNo], [zoneId], [isRead])
        SELECT   [waterMeterReadingId],
                 [waterConnectionId],
                 [waterConnectionTypeId],
                 [waterMeterTypeId],
                 [waterLineTypeId],
                 [waterConnectionStatusId],
                 [bucid],
                 [reading],
                 [previousReading],
                 [previousReadingDate],
                 [readBy],
                 [readingDate],
                 [noOfUnit],
                 [consumption],
                 [standardConsumption],
                 [isPermanentConnection],
                 [sewerage],
                 [solidWaste],
                 [remarks],
                 [billingAddress],
                 [transactionId],
                 [primaryMobileNo],
                 [secondaryMobileNo],
                 [zoneId],
                 [isRead]
        FROM     [dbo].[tblWaterMeterReading]
        ORDER BY [waterMeterReadingId] ASC;
        SET IDENTITY_INSERT [dbo].[tmp_ms_xx_tblWaterMeterReading] OFF;
    END

DROP TABLE [dbo].[tblWaterMeterReading];

EXECUTE sp_rename N'[dbo].[tmp_ms_xx_tblWaterMeterReading]', N'tblWaterMeterReading';

COMMIT TRANSACTION;

SET TRANSACTION ISOLATION LEVEL READ COMMITTED;


GO
PRINT N'Creating [dbo].[FK_tblWaterMeterReading_ToTable_3]...';


GO
ALTER TABLE [dbo].[tblWaterMeterReading] WITH NOCHECK
    ADD CONSTRAINT [FK_tblWaterMeterReading_ToTable_3] FOREIGN KEY ([waterLineTypeId]) REFERENCES [dbo].[mstWaterLineType] ([waterLineTypeId]);


GO
PRINT N'Creating [dbo].[FK_tblWaterMeterReading_ToTable]...';


GO
ALTER TABLE [dbo].[tblWaterMeterReading] WITH NOCHECK
    ADD CONSTRAINT [FK_tblWaterMeterReading_ToTable] FOREIGN KEY ([waterConnectionId]) REFERENCES [dbo].[mstWaterConnection] ([waterConnectionId]);


GO
PRINT N'Creating [dbo].[FK_tblWaterMeterReading_ToTable_1]...';


GO
ALTER TABLE [dbo].[tblWaterMeterReading] WITH NOCHECK
    ADD CONSTRAINT [FK_tblWaterMeterReading_ToTable_1] FOREIGN KEY ([waterConnectionTypeId]) REFERENCES [dbo].[mstWaterConnectionType] ([waterConnectionTypeId]);


GO
PRINT N'Creating [dbo].[FK_tblWaterMeterReading_ToTable_2]...';


GO
ALTER TABLE [dbo].[tblWaterMeterReading] WITH NOCHECK
    ADD CONSTRAINT [FK_tblWaterMeterReading_ToTable_2] FOREIGN KEY ([waterMeterTypeId]) REFERENCES [dbo].[mstWaterMeterType] ([waterMeterTypeId]);


GO
PRINT N'Creating [dbo].[FK_tblWaterMeterReading_ToTable_4]...';


GO
ALTER TABLE [dbo].[tblWaterMeterReading] WITH NOCHECK
    ADD CONSTRAINT [FK_tblWaterMeterReading_ToTable_4] FOREIGN KEY ([waterConnectionStatusId]) REFERENCES [dbo].[enumWaterConnectionStatus] ([waterConnectionStatusId]);


GO
PRINT N'Checking existing data against newly created constraints';


GO
USE [$(DatabaseName)];


GO
ALTER TABLE [dbo].[tblWaterMeterReading] WITH CHECK CHECK CONSTRAINT [FK_tblWaterMeterReading_ToTable_3];

ALTER TABLE [dbo].[tblWaterMeterReading] WITH CHECK CHECK CONSTRAINT [FK_tblWaterMeterReading_ToTable];

ALTER TABLE [dbo].[tblWaterMeterReading] WITH CHECK CHECK CONSTRAINT [FK_tblWaterMeterReading_ToTable_1];

ALTER TABLE [dbo].[tblWaterMeterReading] WITH CHECK CHECK CONSTRAINT [FK_tblWaterMeterReading_ToTable_2];

ALTER TABLE [dbo].[tblWaterMeterReading] WITH CHECK CHECK CONSTRAINT [FK_tblWaterMeterReading_ToTable_4];


GO
PRINT N'Update complete.';


GO
