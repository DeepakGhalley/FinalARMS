/*
Deployment script for tt_db

This code was generated by a tool.
Changes to this file may cause incorrect behavior and will be lost if
the code is regenerated.
*/

GO
SET ANSI_NULLS, ANSI_PADDING, ANSI_WARNINGS, ARITHABORT, CONCAT_NULL_YIELDS_NULL, QUOTED_IDENTIFIER ON;

SET NUMERIC_ROUNDABORT OFF;


GO
:setvar DatabaseName "tt_db"
:setvar DefaultFilePrefix "tt_db"
:setvar DefaultDataPath "C:\Program Files\Microsoft SQL Server\MSSQL15.REVENUE\MSSQL\DATA\"
:setvar DefaultLogPath "C:\Program Files\Microsoft SQL Server\MSSQL15.REVENUE\MSSQL\DATA\"

GO
:on error exit
GO
/*
Detect SQLCMD mode and disable script execution if SQLCMD mode is not supported.
To re-enable the script after enabling SQLCMD mode, execute the following:
SET NOEXEC OFF; 
*/
:setvar __IsSqlCmdEnabled "True"
GO
IF N'$(__IsSqlCmdEnabled)' NOT LIKE N'True'
    BEGIN
        PRINT N'SQLCMD mode must be enabled to successfully execute this script.';
        SET NOEXEC ON;
    END


GO
USE [$(DatabaseName)];


GO
PRINT N'Dropping Default Constraint [dbo].[DF__tmp_ms_xx__noOfU__006AEB82]...';


GO
ALTER TABLE [dbo].[mstWaterConnection] DROP CONSTRAINT [DF__tmp_ms_xx__noOfU__006AEB82];


GO
PRINT N'Dropping Foreign Key [dbo].[FK_tblComplainDetail_ToTable_2]...';


GO
ALTER TABLE [dbo].[tblComplainDetail] DROP CONSTRAINT [FK_tblComplainDetail_ToTable_2];


GO
PRINT N'Dropping Foreign Key [dbo].[FK_tblInaccessibleWaterMeterDetail_ToTable]...';


GO
ALTER TABLE [dbo].[tblInaccessibleWaterMeterDetail] DROP CONSTRAINT [FK_tblInaccessibleWaterMeterDetail_ToTable];


GO
PRINT N'Dropping Foreign Key [dbo].[FK_tblWaterMeterReading_ToTable]...';


GO
ALTER TABLE [dbo].[tblWaterMeterReading] DROP CONSTRAINT [FK_tblWaterMeterReading_ToTable];


GO
PRINT N'Dropping Foreign Key [dbo].[FK_trnWaterConnection_ToTable_10]...';


GO
ALTER TABLE [dbo].[trnWaterConnection] DROP CONSTRAINT [FK_trnWaterConnection_ToTable_10];


GO
PRINT N'Dropping Foreign Key [dbo].[FK_mstWaterConnection_ToTable_2]...';


GO
ALTER TABLE [dbo].[mstWaterConnection] DROP CONSTRAINT [FK_mstWaterConnection_ToTable_2];


GO
PRINT N'Dropping Foreign Key [dbo].[FK_mstWaterConnection_ToTable_3]...';


GO
ALTER TABLE [dbo].[mstWaterConnection] DROP CONSTRAINT [FK_mstWaterConnection_ToTable_3];


GO
PRINT N'Dropping Foreign Key [dbo].[FK_mstWaterConnection_ToTable_4]...';


GO
ALTER TABLE [dbo].[mstWaterConnection] DROP CONSTRAINT [FK_mstWaterConnection_ToTable_4];


GO
PRINT N'Dropping Foreign Key [dbo].[FK_mstWaterConnection_ToTable_5]...';


GO
ALTER TABLE [dbo].[mstWaterConnection] DROP CONSTRAINT [FK_mstWaterConnection_ToTable_5];


GO
PRINT N'Dropping Foreign Key [dbo].[FK_mstWaterConnection_ToTable_6]...';


GO
ALTER TABLE [dbo].[mstWaterConnection] DROP CONSTRAINT [FK_mstWaterConnection_ToTable_6];


GO
PRINT N'Dropping Foreign Key [dbo].[FK_mstWaterConnection_ToTable_7]...';


GO
ALTER TABLE [dbo].[mstWaterConnection] DROP CONSTRAINT [FK_mstWaterConnection_ToTable_7];


GO
PRINT N'Dropping Foreign Key [dbo].[FK_mstWaterConnection_ToTable_1]...';


GO
ALTER TABLE [dbo].[mstWaterConnection] DROP CONSTRAINT [FK_mstWaterConnection_ToTable_1];


GO
PRINT N'Dropping Foreign Key [dbo].[FK_mstWaterConnection_ToTable]...';


GO
ALTER TABLE [dbo].[mstWaterConnection] DROP CONSTRAINT [FK_mstWaterConnection_ToTable];


GO
PRINT N'Starting rebuilding table [dbo].[mstWaterConnection]...';


GO
BEGIN TRANSACTION;

SET TRANSACTION ISOLATION LEVEL SERIALIZABLE;

SET XACT_ABORT ON;

CREATE TABLE [dbo].[tmp_ms_xx_mstWaterConnection] (
    [waterConnectionId]       INT             IDENTITY (1, 1) NOT NULL,
    [landDetailId]            INT             NOT NULL,
    [landOwnershipId]         INT             NOT NULL,
    [waterConnectionStatusId] INT             NOT NULL,
    [ownerTypeId]             INT             NOT NULL,
    [changeTypeId]            SMALLINT        NULL,
    [waterMeterNo]            VARCHAR (145)   NOT NULL,
    [waterMeterTypeId]        INT             NOT NULL,
    [consumerNo]              VARCHAR (145)   NOT NULL,
    [connectionDate]          DATE            NOT NULL,
    [sewerageConnection]      BIT             NOT NULL,
    [solidWaste]              BIT             NOT NULL,
    [waterConnectionTypeId]   INT             NOT NULL,
    [waterLineTypeId]         INT             NOT NULL,
    [standardConsumption]     INT             NOT NULL,
    [createdBy]               INT             NOT NULL,
    [createdOn]               DATE            NOT NULL,
    [modifiedBy]              INT             NULL,
    [modifiedOn]              DATE            NULL,
    [billingAddress]          VARCHAR (100)   NOT NULL,
    [zoneId]                  INT             NOT NULL,
    [flatNo]                  VARCHAR (45)    NULL,
    [initialReading]          DECIMAL (10, 2) NOT NULL,
    [organisationName]        VARCHAR (450)   NULL,
    [isActive]                BIT             NOT NULL,
    [isPermanentConnection]   BIT             NULL,
    [remarks]                 VARCHAR (450)   NULL,
    [isPermanentDisconnect]   BIT             NULL,
    [disconnectDate]          DATE            NULL,
    [noOfUnits]               INT             DEFAULT 1 NOT NULL,
    [reconnectionDate]        DATE            NULL,
    [sewarageConnectionDate]  DATE            NULL,
    [sewarageConnectedBy]     INT             NULL,
    [primaryMobileNo]         VARCHAR (8)     NOT NULL,
    [secondaryMobileNo]       VARCHAR (8)     NULL,
    [transactionId]           BIGINT          NULL,
    [maxReadingDate]          DATE            NULL,
    PRIMARY KEY CLUSTERED ([waterConnectionId] ASC)
);

IF EXISTS (SELECT TOP 1 1 
           FROM   [dbo].[mstWaterConnection])
    BEGIN
        SET IDENTITY_INSERT [dbo].[tmp_ms_xx_mstWaterConnection] ON;
        INSERT INTO [dbo].[tmp_ms_xx_mstWaterConnection] ([waterConnectionId], [landDetailId], [landOwnershipId], [waterConnectionStatusId], [ownerTypeId], [changeTypeId], [waterMeterNo], [waterMeterTypeId], [consumerNo], [connectionDate], [sewerageConnection], [solidWaste], [waterConnectionTypeId], [waterLineTypeId], [standardConsumption], [createdBy], [createdOn], [modifiedBy], [modifiedOn], [billingAddress], [zoneId], [flatNo], [initialReading], [organisationName], [isActive], [isPermanentConnection], [remarks], [isPermanentDisconnect], [disconnectDate], [noOfUnits], [reconnectionDate], [sewarageConnectionDate], [sewarageConnectedBy], [primaryMobileNo], [secondaryMobileNo], [transactionId], [maxReadingDate])
        SELECT   [waterConnectionId],
                 [landDetailId],
                 [landOwnershipId],
                 [waterConnectionStatusId],
                 [ownerTypeId],
                 [changeTypeId],
                 [waterMeterNo],
                 [waterMeterTypeId],
                 [consumerNo],
                 [connectionDate],
                 [sewerageConnection],
                 [solidWaste],
                 [waterConnectionTypeId],
                 [waterLineTypeId],
                 [standardConsumption],
                 [createdBy],
                 [createdOn],
                 [modifiedBy],
                 [modifiedOn],
                 [billingAddress],
                 [zoneId],
                 [flatNo],
                 [initialReading],
                 [organisationName],
                 [isActive],
                 [isPermanentConnection],
                 [remarks],
                 [isPermanentDisconnect],
                 [disconnectDate],
                 [noOfUnits],
                 [reconnectionDate],
                 [sewarageConnectionDate],
                 [sewarageConnectedBy],
                 [primaryMobileNo],
                 [secondaryMobileNo],
                 [transactionId],
                 [maxReadingDate]
        FROM     [dbo].[mstWaterConnection]
        ORDER BY [waterConnectionId] ASC;
        SET IDENTITY_INSERT [dbo].[tmp_ms_xx_mstWaterConnection] OFF;
    END

DROP TABLE [dbo].[mstWaterConnection];

EXECUTE sp_rename N'[dbo].[tmp_ms_xx_mstWaterConnection]', N'mstWaterConnection';

COMMIT TRANSACTION;

SET TRANSACTION ISOLATION LEVEL READ COMMITTED;


GO
PRINT N'Creating Foreign Key [dbo].[FK_tblComplainDetail_ToTable_2]...';


GO
ALTER TABLE [dbo].[tblComplainDetail] WITH NOCHECK
    ADD CONSTRAINT [FK_tblComplainDetail_ToTable_2] FOREIGN KEY ([waterConnectionId]) REFERENCES [dbo].[mstWaterConnection] ([waterConnectionId]);


GO
PRINT N'Creating Foreign Key [dbo].[FK_tblInaccessibleWaterMeterDetail_ToTable]...';


GO
ALTER TABLE [dbo].[tblInaccessibleWaterMeterDetail] WITH NOCHECK
    ADD CONSTRAINT [FK_tblInaccessibleWaterMeterDetail_ToTable] FOREIGN KEY ([waterConnectionId]) REFERENCES [dbo].[mstWaterConnection] ([waterConnectionId]);


GO
PRINT N'Creating Foreign Key [dbo].[FK_tblWaterMeterReading_ToTable]...';


GO
ALTER TABLE [dbo].[tblWaterMeterReading] WITH NOCHECK
    ADD CONSTRAINT [FK_tblWaterMeterReading_ToTable] FOREIGN KEY ([waterConnectionId]) REFERENCES [dbo].[mstWaterConnection] ([waterConnectionId]);


GO
PRINT N'Creating Foreign Key [dbo].[FK_trnWaterConnection_ToTable_10]...';


GO
ALTER TABLE [dbo].[trnWaterConnection] WITH NOCHECK
    ADD CONSTRAINT [FK_trnWaterConnection_ToTable_10] FOREIGN KEY ([oldWaterConnectionId]) REFERENCES [dbo].[mstWaterConnection] ([waterConnectionId]);


GO
PRINT N'Creating Foreign Key [dbo].[FK_mstWaterConnection_ToTable_2]...';


GO
ALTER TABLE [dbo].[mstWaterConnection] WITH NOCHECK
    ADD CONSTRAINT [FK_mstWaterConnection_ToTable_2] FOREIGN KEY ([waterConnectionStatusId]) REFERENCES [dbo].[enumWaterConnectionStatus] ([waterConnectionStatusId]);


GO
PRINT N'Creating Foreign Key [dbo].[FK_mstWaterConnection_ToTable_3]...';


GO
ALTER TABLE [dbo].[mstWaterConnection] WITH NOCHECK
    ADD CONSTRAINT [FK_mstWaterConnection_ToTable_3] FOREIGN KEY ([waterConnectionTypeId]) REFERENCES [dbo].[mstWaterConnectionType] ([waterConnectionTypeId]);


GO
PRINT N'Creating Foreign Key [dbo].[FK_mstWaterConnection_ToTable_4]...';


GO
ALTER TABLE [dbo].[mstWaterConnection] WITH NOCHECK
    ADD CONSTRAINT [FK_mstWaterConnection_ToTable_4] FOREIGN KEY ([waterLineTypeId]) REFERENCES [dbo].[mstWaterLineType] ([waterLineTypeId]);


GO
PRINT N'Creating Foreign Key [dbo].[FK_mstWaterConnection_ToTable_5]...';


GO
ALTER TABLE [dbo].[mstWaterConnection] WITH NOCHECK
    ADD CONSTRAINT [FK_mstWaterConnection_ToTable_5] FOREIGN KEY ([zoneId]) REFERENCES [dbo].[mstZone] ([zoneId]);


GO
PRINT N'Creating Foreign Key [dbo].[FK_mstWaterConnection_ToTable_6]...';


GO
ALTER TABLE [dbo].[mstWaterConnection] WITH NOCHECK
    ADD CONSTRAINT [FK_mstWaterConnection_ToTable_6] FOREIGN KEY ([ownerTypeId]) REFERENCES [dbo].[enumOwnerType] ([ownerTypeId]);


GO
PRINT N'Creating Foreign Key [dbo].[FK_mstWaterConnection_ToTable_7]...';


GO
ALTER TABLE [dbo].[mstWaterConnection] WITH NOCHECK
    ADD CONSTRAINT [FK_mstWaterConnection_ToTable_7] FOREIGN KEY ([landOwnershipId]) REFERENCES [dbo].[tblLandOwnershipDetail] ([landOwnershipId]);


GO
PRINT N'Creating Foreign Key [dbo].[FK_mstWaterConnection_ToTable_1]...';


GO
ALTER TABLE [dbo].[mstWaterConnection] WITH NOCHECK
    ADD CONSTRAINT [FK_mstWaterConnection_ToTable_1] FOREIGN KEY ([waterMeterTypeId]) REFERENCES [dbo].[mstWaterMeterType] ([waterMeterTypeId]);


GO
PRINT N'Creating Foreign Key [dbo].[FK_mstWaterConnection_ToTable]...';


GO
ALTER TABLE [dbo].[mstWaterConnection] WITH NOCHECK
    ADD CONSTRAINT [FK_mstWaterConnection_ToTable] FOREIGN KEY ([landDetailId]) REFERENCES [dbo].[mstLandDetail] ([landDetailId]);


GO
PRINT N'Refreshing View [dbo].[View_ReadingSeet]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[View_ReadingSeet]';


GO
PRINT N'Refreshing Procedure [dbo].[rptDefaulterWaterList]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[rptDefaulterWaterList]';


GO
PRINT N'Refreshing Procedure [dbo].[rptGetWaterConsumption]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[rptGetWaterConsumption]';


GO
PRINT N'Refreshing Procedure [dbo].[rptMissedOutReadingReport]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[rptMissedOutReadingReport]';


GO
PRINT N'Refreshing Procedure [dbo].[rptMonthlyMeterReader]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[rptMonthlyMeterReader]';


GO
PRINT N'Refreshing Procedure [dbo].[rptMonthlyZoneWiseWaterConsumption]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[rptMonthlyZoneWiseWaterConsumption]';


GO
PRINT N'Refreshing Procedure [dbo].[rptZoneWiseWaterCollection]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[rptZoneWiseWaterCollection]';


GO
PRINT N'Refreshing Procedure [dbo].[rptZoneWiseWaterConsumption]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[rptZoneWiseWaterConsumption]';


GO
PRINT N'Checking existing data against newly created constraints';


GO
USE [$(DatabaseName)];


GO
ALTER TABLE [dbo].[tblComplainDetail] WITH CHECK CHECK CONSTRAINT [FK_tblComplainDetail_ToTable_2];

ALTER TABLE [dbo].[tblInaccessibleWaterMeterDetail] WITH CHECK CHECK CONSTRAINT [FK_tblInaccessibleWaterMeterDetail_ToTable];

ALTER TABLE [dbo].[tblWaterMeterReading] WITH CHECK CHECK CONSTRAINT [FK_tblWaterMeterReading_ToTable];

ALTER TABLE [dbo].[trnWaterConnection] WITH CHECK CHECK CONSTRAINT [FK_trnWaterConnection_ToTable_10];

ALTER TABLE [dbo].[mstWaterConnection] WITH CHECK CHECK CONSTRAINT [FK_mstWaterConnection_ToTable_2];

ALTER TABLE [dbo].[mstWaterConnection] WITH CHECK CHECK CONSTRAINT [FK_mstWaterConnection_ToTable_3];

ALTER TABLE [dbo].[mstWaterConnection] WITH CHECK CHECK CONSTRAINT [FK_mstWaterConnection_ToTable_4];

ALTER TABLE [dbo].[mstWaterConnection] WITH CHECK CHECK CONSTRAINT [FK_mstWaterConnection_ToTable_5];

ALTER TABLE [dbo].[mstWaterConnection] WITH CHECK CHECK CONSTRAINT [FK_mstWaterConnection_ToTable_6];

ALTER TABLE [dbo].[mstWaterConnection] WITH CHECK CHECK CONSTRAINT [FK_mstWaterConnection_ToTable_7];

ALTER TABLE [dbo].[mstWaterConnection] WITH CHECK CHECK CONSTRAINT [FK_mstWaterConnection_ToTable_1];

ALTER TABLE [dbo].[mstWaterConnection] WITH CHECK CHECK CONSTRAINT [FK_mstWaterConnection_ToTable];


GO
PRINT N'Update complete.';


GO
