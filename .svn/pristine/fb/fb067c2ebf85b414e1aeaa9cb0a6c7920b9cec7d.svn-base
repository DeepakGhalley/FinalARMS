@using CORE_BOL
@model TranWaterConnectionModel
@{
    ViewData["Title"] = "WaterDisconnection";
    Layout = "~/Views/Shared/_Layout.cshtml";
}


<div class="dialog-background" style="display:none" id="img">
    <div class="dialog-loading-wrapper">
        <span class="dialog-loading-icon"><img src="~/dist/img/loader.gif" style="width: 100px; height: 100px;" /></span>
    </div>
</div>


<div class="content-header">
    <div class="container-fluid">
        <div class="row mb-2">
            <div class="col-sm-6">
                <h1 class="m-0 text-dark"></h1>
            </div>
            <div class="col-sm-6">
                <ol class="breadcrumb float-sm-right">
                    <li class="breadcrumb-item"><a asp-action="Index">Water Transaction</a></li>
                    <li class="breadcrumb-item active">Water Disconnection</li>
                </ol>
            </div>
        </div>
    </div>
</div>

<!--SEARCH-->
<div class="card card-info">
    @if (TempData["msg"] != null)
    {
        <div class="alert alert-success alert-dismissible">
            <button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button>
            <h5><i class="icon fas fa-check"></i> Alert!</h5>
            <p>@TempData["msg"]</p>
        </div>
    }

    <div class="card-header">
        <h3 class="card-title">Search Details</h3>
    </div>
    <div class="card-body">
        <div asp-validation-summary="ModelOnly" class="text-danger"></div>
        <div class="form-group row">
            <div class="input-group d-flex justify-content-center col-5">
                <label class="col-sm-4 col-form-label">CID:</label>
                <input id="cid" class="form-control col-6" />
            </div>
            <div class="input-group d-flex justify-content-center col-5">
                <label class="col-sm-4 col-form-label">Consumer No:</label>
                <input id="consumerno" class="form-control col-6" />
            </div>
        </div>
        <div class="form-group row">
            <div class="input-group d-flex justify-content-center col-5">
                <label class="col-sm-4 col-form-label">TTIN:</label>
                <input id="ttin" class="form-control col-6" />
            </div>
            <div class="input-group d-flex justify-content-center col-5">
                <label class="col-sm-4 col-form-label">Meter No:</label>
                <input id="meterno" class="form-control col-6" />
            </div>
            <div class="input-group-append col-2">
                &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                <input type="button" value="Search" class="btn btn-primary" onclick="return getDetails();" />
            </div>
        </div>
    </div>
</div>

<!--TAX PAYER DETAILS-->
<div class="card card-info" id="TaxPayerDetails" style="display:none;">
    <div class="card-header">
        <div class="card-title">Tax Payer's Details</div>
    </div>
    <div class="card-body">
        <div class="form-group row">
            <label class="col-sm-2 col-form-label">Name:</label>
            <div class="col-sm-2">
                <lable id="Name" class="col-form-label font-weight-normal"></lable>
            </div>
            <label class="col-sm-2 col-form-label">Mobile No:</label>
            <div class="col-sm-2">
                <label id="MobileNo" class="col-form-label font-weight-normal"></label>
            </div>
            <label class="col-sm-2 col-form-label">Billing Address:</label>
            <div class="col-sm-2">
                <label id="BAddress" class="col-form-label font-weight-normal"></label>
            </div>
        </div>
    </div>

    <div class="card-body">
        <div class="form-group row">
            <label class="col-sm-2 col-form-label">Consumer No:</label>
            <div class="col-sm-2">
                <lable id="ConsumerNo" class="col-form-label font-weight-normal"></lable>
            </div>
            <label class="col-sm-2 col-form-label">Meter No:</label>
            <div class="col-sm-2">
                <label id="MeterNo" class="col-form-label font-weight-normal"></label>
            </div>
          
        </div>
    </div>
</div>

<!--LAND DETAILS-->
<div class="card card-info" id="LandDetails" style="display:none;">
    <div class="card-header">
        <div class="card-title">Land Details</div>
    </div>
    <div class="card-body">
        <table class="table table-bordered table-striped">
            <thead style="background-color:mediumaquamarine">
                <tr>
                    <th>#</th>
                    <th>Plot No</th>
                    <th>Land Acerage</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody id="tbl_Body">
            </tbody>
        </table>
    </div>
</div>

<!--WATER CONNECTION DETALS-->
<div class="card card-info" id="WaterConnectionDetails" style="display:none;">
    <div class="card-header">
        <div class="card-title">Water Connection Details</div>
    </div>
    <div class="card-body">
        <table class="table table-bordered table-striped">
            <thead style="background-color:mediumaquamarine">
                <tr>
                    <th>#</th>
                    <th>Connection Status</th>
                    <th>Water Meter No</th>
                    <th>Consumer No</th>
                    <th>Connection Date</th>
                    <th>Line Type</th>
                    <th>Connection Type</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody id="tblBody">
            </tbody>
        </table>
    </div>
</div>

<!--WATER DISCONNECTIONS-->

    <div class="card card-info" id="WaterDisconnection" style="display:none;">
        <div class="card-header">
            <div class="card-title">Water Disconnection</div>
        </div>
        <div class="card-body">
            <div asp-validation-summary="ModelOnly" class="text-danger"></div>
            <div style="display:none;">
                <input asp-for="WaterConnectionId" id="hdnwaterconnectionId" />
                <input type="hidden" id="hdnconsumerno" />

            </div>
            <div class="form-group row">
               

                <label asp-for="DisconnectDate" class="col-sm-2 col-form-label">Disconnection Date<span style="font-weight: bold; color: red;">*</span></label>
                <div class="col-sm-3">
                    <input asp-for="DisconnectDate" class="form-control" type="date" />
                    <span asp-validation-for="DisconnectDate" class="text-danger"></span>
                </div>
            </div>
            <div class="form-group row">
                <label asp-for="Remarks" class="col-sm-2 col-form-label">Remarks<span style="font-weight: bold; color: red;">*</span></label>
                <div class="col-sm-3">
                    <textarea asp-for="Remarks" class="form-control" placeholder="Remarks"></textarea>
                    <span asp-validation-for="Remarks" class="text-danger"></span>
                </div>

                <label asp-for="IsPermanentDisconnect" class="col-sm-2 col-form-label">Disconnection<span style="font-weight: bold; color: red;">*</span></label>
                @*<input type="checkbox" class="form-control" asp-for="IsPermanentDisconnect" />*@
                <div class="col-sm-3">
                    <select asp-for="IPD" class="form-control select2bs4" style="width: 100%;" value="0">
                        <option>-- Select One --</option>
                        <option value="1">Permanent</option>
                        <option value="2">Temporary</option>
                    </select>
                    <span asp-validation-for="IsPermanentDisconnect" class="text-danger"></span>
                </div>
            </div>
            <div class="form-group row">
                <label class="col-sm-2 col-form-label"></label>
                <div class="col-sm-6">
                    <button type="button" class="btn btn-primary" onclick="return saveme();">Save</button>
                    <button type="reset" id="btnCancel" class="btn btn-warning" onclick="return close();">Cancel</button>
                </div>
            </div>
        </div>
    </div>


    <script>
    //SEARCH AND GET DETAILS OF LAND & TAX PAYER
    function getDetails() {
        if ($('#cid').val() == "" && $('#ttin').val() == "" && $('#consumerno').val() == "" && $('#meterno').val() == "") {
            swal("Please fill any of the fields!", "", "error");
            return false;
        }
        var Cid = $('#cid').val();
        var Ttin = $('#ttin').val();
        var ConsumerNo = $('#consumerno').val();
        var MeterNo = $('#meterno').val();

        $.ajax({
            type: "GET",
            url: '@Url.Action("GetWaterDisconnection", "TranWaterConnections")',
            data: {
                cid: Cid,
                ttin: Ttin,
                consumerno: ConsumerNo,
                meterno: MeterNo
            },
            success: function (data) {
                $('#tbl_Body').empty();

                if (data.length > 0) {
                    //TAX PAYER DETAILS
                    var BillingAddress = data[0].billingAddress;
                    var ConsumerNo = data[0].consumerNo;
                    var WaterMeterNo = data[0].waterMeterNo;
                    var WaterMeterType = data[0].waterMeterType;
                    var TaxPayerName = data[0].taxPayerName;
                    var PrimaryMobileNo = data[0].primaryMobileNo;

                    $('#ConsumerNo').text(ConsumerNo);
                    $('#Name').text(TaxPayerName);
                    $('#MobileNo').text(PrimaryMobileNo);
                    $('#BAddress').text(BillingAddress);
                    $('#MeterNo').text(WaterMeterNo);
                    $('#MeterType').text(WaterMeterType);

                    //LAND DETAILS
                    $.each(data, function (key, value) {
                    $('#tbl_Body').append(
                        '<tr>'
                        + '<td>' + (key + 1) + '</td>'
                        + '<td>' + value.plotNo + '</td>'
                        + '<td>' + value.landAcerage + '</td>'
                        + '<td><b><a style="color: forestgreen; cursor: pointer;" title="select" onclick="return displayWaterConnectionDetails(' + value.waterConnectionId + ');"> select </a></b></td>'
                        + '</tr>');
                    });

                    $('#TaxPayerDetails').show(1000);
                    $('#LandDetails').show(1000);

                }

                else {
                    $('#TaxPayerDetails').hide(1000);
                    $('#LandDetails').hide(1000);

                    swal(
                        'This consumer has already disconnected!', '', 'warning'
                    );
                }
            },
            error: function () {
                alert('error');
            }
        });
    }

    //GET WATER CONNECTION DETAILS
    function displayWaterConnectionDetails(waterConnectionId) {
        $.ajax({
            type: "GET",
            url: '@Url.Action("GetWaterConnectionDetails", "TranWaterConnections")',
            data: {
                id: waterConnectionId
            },
            success: function (data) {
                $('#tblBody').empty();

                if (data.length > 0) {
                    var waterConnectionId = data[0].waterConnectionId;

                    $('#hdnwaterconnectionId').val(waterConnectionId);
                   
                    $.each(data, function (key, value) {
                        //Displaying Date
                        const d = new Date(value.connectionDate);
                        const ConnectionDate = d.getFullYear() + '-' + ("0" + (d.getMonth() + 1)).slice(-2) + '-' + ("0" + d.getDate()).slice(-2)

                        $('#tblBody').append(
                            '<tr>'
                            + '<td>' + (key + 1) + '</td>'
                            + '<td>' + value.waterConnectionStatus + '</td>'
                            + '<td>' + value.waterMeterNo + '</td>'
                            + '<td>' + value.consumerNo + '</td>'
                            + '<td>' + ConnectionDate + '</td>'
                            + '<td>' + value.waterLineType + '</td>'
                            + '<td>' + value.waterConnectionType + '</td>'
                            + '<td><b><a style="color: forestgreen; cursor: pointer;" title="select" onclick="return displayWaterDisconnectionDetails(' + waterConnectionId + ');"> select </a></b></td>'
                            + '</tr>');
                    });

                    $('#WaterConnectionDetails').toggle(1000);
                }

                else {
                    $('#WaterConnectionDetails').hide(1000);
                }
            },
            error: function () {
                alert('error');
            }
        });
    }
        function displayWaterDisconnectionDetails(waterConnectionId) {
            $('#WaterDisconnection').toggle(1000);
        }
        function saveme() {
           
            var WCI = $('#hdnwaterconnectionId').val();
         $.ajax({
            type: "GET",
            url: '@Url.Action("checkpayment", "TranWaterConnections")',
            data: {
                WaterConnectionId: WCI
            },
             success: function (data) {
                 if (data.length > 0) {
                    
                     swal({
                         title: 'Please Make a payment first for this consumer!',

                         confirmButtonText: 'OK'
                     });
                 }
                 else {
                     save();
                 }
            },
            error: function () {
                alert('error');
            }
        });
    }
    //WATER CONNECTION DETAILS
        function save() {
           
        var myarray = [];
        var TranWaterConnectionModel = {};

        TranWaterConnectionModel.WaterConnectionId = parseInt($('#hdnwaterconnectionId').val());
        TranWaterConnectionModel.Remarks = $('#Remarks').val();
        TranWaterConnectionModel.DisconnectDate = ($('#DisconnectDate').val());
        TranWaterConnectionModel.IPD = parseInt($('#IPD').val());


            myarray.push(TranWaterConnectionModel);
                var json_data = JSON.stringify(myarray);
                console.log(json_data);
                $('#img').show();

            $.ajax({
                type: "POST",
                url: '@Url.Action("saveWaterDisconnection", "TranWaterConnections")',
                data: json_data,
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                success: function (response) {
                    $('#img').hide();
                    //displaydemand(response);

                    swal( "success");
                    $('#TaxPayerDetails').hide(1000);
                    $('#LandDetails').hide(1000);
                    $('#WaterConnectionDetails').hide(1000);
                    $('#WaterDisconnection').hide(1000);



                },
                failure: function () {
                    $('#img').hide();
                    swal('Creation Failed', '', 'error');
                },
                error: function () {
                    $('#img').hide();
                    swal('Error while inserting');
                }
            });
        }
    </script>